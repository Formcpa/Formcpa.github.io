<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Financeiro - Painel</title>
  <!-- Biblioteca do Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#e8ecf1; --card:#f0f3f7; --muted:#6b7684; --accent:#2b7be4; --success:#17b169; --danger:#ff4d4f;
      --shadow: 0 6px 18px rgba(30,50,80,0.08);
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#17233b}

    /* SIDEBAR */
    .layout{display:flex;min-height:100vh}
    aside{width:320px;background:#ffffff;border-right:1px solid #e6edf6;padding:22px;box-shadow:var(--shadow);position:fixed;left:0;top:0;bottom:0;display:flex;flex-direction:column}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .brand img{width:38px;height:38px;border-radius:8px;object-fit:cover}
    .brand h1{font-size:18px;margin:0}
    nav{margin-top:8px}
    .nav-item{padding:10px 12px;border-radius:8px;color:#17324a;display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:pointer}
    .nav-item:hover{background:#f0f6ff}
    .section-title{font-size:12px;color:var(--muted);margin:18px 0 8px}

    /* platforms list */
    .platforms-list { flex:1; overflow-y: auto; padding-right: 8px; min-height:0; }
    .platform-card {
      background: #fdfdff;
      border: 1px solid #e6edf6;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .platform-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(43, 123, 228, 0.1);
    }
    .platform-card .name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      word-break: break-all;
      color: #17233b;
    }
    .platform-card .details {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .platform-card .count {
      font-size: 12px;
      color: var(--muted);
      background: rgba(0,0,0,0.04);
      padding: 3px 6px;
      border-radius: 4px;
    }
    .platform-card .actions { display: flex; gap: 6px; }
    .platform-card .actions .btn { padding: 4px 10px; font-size: 12px; }
    .platform-card .actions .btn-delete { background: transparent; color: var(--muted); border: none; padding: 4px; font-size: 16px; }
    .platform-card .actions .btn-delete:hover { color: var(--danger); background: rgba(255, 77, 79, 0.1); box-shadow: none; transform: none; }

    .platform-card.selected {
      border-left: 3px solid var(--success);
      background-color: rgba(23, 177, 105, 0.05);
    }

    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(43,123,228,0.12)}

    .btn.ghost.active {
      background: rgba(43,123,228,0.1);
      font-weight: 600;
    }

    .btn.danger {
      background: var(--danger);
      border-color: var(--danger);
    }
    .btn.danger:hover {
      background: #ff7875;
    }

    .btn.ghost.success {
      color: var(--success);
      border-color: rgba(23, 177, 105, 0.2);
    }
    .btn.ghost.success:hover {
      background: rgba(23, 177, 105, 0.1);
    }
    
    .btn.success {
      background: var(--success);
      color: white;
    }
    .btn.success:hover {
      background: #129e5e;
    }

    /* main content */
    main{margin-left:340px;padding:28px;flex:1}
    header.top{display:flex;align-items:center;justify-content:space-between}
    .cards{display:flex;gap:18px;margin-top:14px;flex-wrap:wrap}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--shadow);min-width:200px}
    .card h3{margin:0;font-size:13px;color:var(--muted)}
    .card p{font-size:20px;margin:8px 0 0;font-weight:600}
    .card p.lucro{color:var(--success) !important;}
    .card p.negative{color:var(--danger) !important;}

    .panel{margin-top:22px;background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--shadow)}
    .row{display:flex;gap:12px;align-items:center}
    .field{flex:1}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    
    .header-left { display:flex; align-items:center; gap: 12px; }
    .header-right { text-align:right; display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
    .header-actions { display:flex; align-items:center; gap:8px; }

    input[type=number], input[type=text], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf6;background:#fbfdff}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eef3f8;text-align:left}
    th{background:transparent;color:var(--muted);font-weight:600}
    .small{width:90px}
    .lucro{font-weight:700;color:var(--success) !important;}
    .negative{font-weight:700;color:var(--danger) !important;}

    .actions{text-align:right}
    .muted{color:var(--muted);font-size:13px}

    footer{margin-top:22px;color:var(--muted);font-size:13px}

    .note-card{background:var(--card);padding:14px;border-radius:10px;margin-bottom:12px;box-shadow:var(--shadow);border:1px solid #e6edf6;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .note-card.used{opacity:0.5;background:rgba(82,196,26,0.05)}
    .note-card .cpf-text{flex:1;font-family:monospace;font-size:14px;color:#17233b;font-weight:500}
    .note-card input[type="checkbox"]{width:18px;height:18px;cursor:pointer;flex-shrink:0}
    body.dark .note-card{border-color:#2a2d33;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
    body.dark .note-card .cpf-text{color:#e6eef8}
    body.dark .note-card.used{background:rgba(82,196,26,0.08)}

    .btn-notes-container {
      position: relative;
    }
    .notes-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background-color: var(--danger);
      color: white;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      font-size: 10px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--card);
      pointer-events: none;
    }
    
    /* Prompt Input Styling */
    #promptInput { width: 100%; padding: 12px; border: 1px solid #e6edf6; border-radius: 8px; background: #fbfdff; font-size: 14px; margin-top: 8px; }
    #promptInput:focus { background: #fff; border-color: var(--accent); }

    /* Modal de Notas */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
    }
    .modal-content {
      background-color: var(--card);
      margin: 10% auto;
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow);
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .modal-header h3 { margin: 0; }
    .close-modal {
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
    }
    .notes-container { max-height: 300px; overflow-y: auto; margin-bottom: 16px; }
    .note-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.03); border-radius: 6px; margin-bottom: 8px; }
    body.dark .note-item { background: rgba(255,255,255,0.05); }
    .note-item span { font-size: 14px; flex: 1; margin-right: 10px; }
    .add-note-box { display: flex; gap: 8px; }

    /* responsive */
    #mobileMenuBtn { display: none; }
    .sidebar-overlay { display: none; }

    @media (max-width:900px){
      aside {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 1000;
        width: 280px;
      }
      aside.open {
        transform: translateX(0);
      }
      main { margin-left:0; padding:16px; width: 100%; }
      
      #mobileMenuBtn {
        display: inline-flex;
        margin-right: 12px;
        font-size: 24px;
        padding: 4px;
        border: none;
        background: transparent;
        color: inherit;
        cursor: pointer;
      }
      
      .sidebar-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .sidebar-overlay.open {
        display: block;
        opacity: 1;
      }
      
      .panel, .daily-box { overflow-x: auto; }
      .card { flex: 1 1 100%; }
      
      header.top { flex-direction: column; align-items: stretch; gap: 16px; }
      .header-right { align-items: center; text-align: center; width: 100%; }
      .header-actions { justify-content: center; width: 100%; flex-wrap: wrap; }
    }

    /* Anima√ß√µes suaves */
    * {
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, opacity 0.2s ease, transform 0.2s ease;
    }
    .btn {
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(43, 123, 228, 0.3);
    }
    .btn:active {
      transform: translateY(0);
    }
    .card {
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(30,50,80,0.12);
    }
    .nav-item {
      transition: all 0.2s ease;
    }
    .platform-card {
      transition: all 0.2s ease;
    }
    .note-card {
      transition: all 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .panel, .card {
      animation: fadeIn 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(43, 123, 228, 0.1);
    }
  
    /* Dark-mode fixes: daily box, tables, inputs */
    .daily-box {
      margin-top:20px;
      padding:12px;
      background:var(--card);
      border-radius:10px;
    }
    body.dark .daily-box { background:#1c1f24; }

    body.dark table { background:#1a1d22; color:#e5e7eb; }
    body.dark th { color:#9ca3af; background:#1a1d22; }
    body.dark td { border-color:#2a2d33; }



    /* ensure cards and panels use variables so dark mode applies */
    body.dark .card { background: #1a1d22; }
    body.dark .panel { background: #1a1d22; }


/* FORCE full-site dark mode overrides */
body.dark, body.dark main, body.dark header, body.dark footer, body.dark aside, body.dark .layout {
  background: #0b0c0e !important;
  color: #e6eef8 !important;
}
body.dark .brand h1, body.dark .muted, body.dark th, body.dark label {
  color: #9aa6b2 !important;
}
body.dark aside { background: #0f1215 !important; border-right-color: #1f2326 !important; }
body.dark nav .nav-item { color: #b9c6cf !important; }
body.dark .nav-item:hover { background: rgba(255,255,255,0.02) !important; }body.dark .platform-card {
      background: #13171c;
      border-color: #2a2d33;
    }
    body.dark .platform-card:hover {
      border-color: var(--accent);
      background: #161b22;
    }
    body.dark .platform-card .name { color: #c9d8e4; }
    body.dark .platform-card .count { background: rgba(255,255,255,0.05); color: #8f9aa3; }
    body.dark .platform-card .actions .btn-delete { color: #77818f; }

    body.dark .platform-card.selected {
      background-color: rgba(23, 177, 105, 0.1);
    }
    body.dark .platform-card .actions .btn-edit-plat:hover {
      background: rgba(59, 130, 246, 0.15);
    }
    body.dark .platform-card .actions .btn-delete:hover {
      background-color: rgba(23, 177, 105, 0.1);
    }

    body.dark .btn.danger:hover {
      background: #d9363e;
    }

    body.dark #searchPlatforms {
      background: #0b0c0e !important; color: #e6eef8 !important; border-color: #222428 !important;
    }

    /* Add Platform Input Styling */
    .add-platform-wrapper {
      position: relative;
      margin-top: 12px;
    }
    .add-platform-wrapper input {
      width: 100%;
      padding: 10px 12px;
      padding-right: 45px;
      border-radius: 8px;
      border: 1px solid #e6edf6;
      background: #fbfdff;
      font-size: 13px;
    }
    .add-platform-wrapper input:focus {
      background: #fff;
    }
    .add-platform-wrapper button {
      position: absolute;
      right: 5px;
      top: 5px;
      bottom: 5px;
      width: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      font-size: 18px;
    }

body.dark input, body.dark select, body.dark textarea {
  background: #0b0c0e !important;
  color: #e6eef8 !important;
  border-color: #222428 !important;
}
body.dark .card, body.dark .panel, body.dark .daily-box {
  background: #0f1316 !important;
  box-shadow: 0 6px 18px rgba(0,0,0,0.6) !important;
}
body.dark table { background: transparent !important; color: #d7e6f2 !important; }
body.dark th, body.dark td { border-color: #222428 !important; color: #c9d8e4 !important; }
body.dark .btn { box-shadow: none; }
body.dark .btn.ghost { background: transparent !important; color: #9fb8ff !important; border-color: rgba(159,184,255,0.08) !important; }
body.dark .brand img { filter: none !important; }
body.dark .cards .card p { color: #d7e6f2 !important; }
body.dark .cards .card h3 { color: #9aa6b2 !important; }
body.dark footer, body.dark .muted { color: #8f9aa3 !important; }
/* These MUST come last to override the generic .cards .card p rule above */
body.dark .lucro { color: #17b169 !important; }
body.dark .negative { color: #ff4d4f !important; }
body.dark .card p.lucro { color: #17b169 !important; }
body.dark .card p.negative { color: #ff4d4f !important; }
body.dark .cards .card p.lucro { color: #17b169 !important; }
body.dark .cards .card p.negative { color: #ff4d4f !important; }
body.dark #lucroTotalDisplay.lucro { color: #17b169 !important; }
body.dark #lucroTotalDisplay.negative { color: #ff4d4f !important; }

    /* Loading Spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(43, 123, 228, 0.2);
      border-left-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .provider-card.selected {
      border-color: var(--accent) !important;
      background: rgba(43, 123, 228, 0.05);
    }

    /* China SMS Grid & List */
    .service-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
    .service-item { background: var(--bg); border: 1px solid #e6edf6; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; }
    .service-item:hover { border-color: var(--accent); background: rgba(43, 123, 228, 0.05); transform: translateY(-2px); }
    .service-icon { font-size: 28px; margin-bottom: 8px; }
    .service-name { font-size: 13px; font-weight: 600; color: var(--text); }
    
    .server-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
    .server-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #e6edf6; border-radius: 8px; background: var(--bg); transition: all 0.2s; }
    .server-item:hover { border-color: var(--accent); background: rgba(43, 123, 228, 0.05); }
    
    body.dark .service-item, body.dark .server-item { background: #13171c; border-color: #2a2d33; }
    body.dark .service-item:hover, body.dark .server-item:hover { background: #161b22; border-color: var(--accent); }
    body.dark .service-name { color: #e6eef8; }

    /* SMS Tabs Styling */
    .sms-tabs { display: flex; background: var(--card); border-radius: 8px; padding: 4px; border: 1px solid #e6edf6; margin-bottom: 16px; gap: 4px; }
    .sms-tab-btn { flex: 1; border: none; background: transparent; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 500; color: var(--muted); transition: all 0.2s; font-size: 13px; }
    .sms-tab-btn:hover { background: rgba(0,0,0,0.03); color: var(--text); }
    .sms-tab-btn.active { background: var(--accent); color: white; box-shadow: 0 2px 4px rgba(43, 123, 228, 0.3); }
    
    body.dark .sms-tabs { background: #13171c; border-color: #2a2d33; }
    body.dark .sms-tab-btn:hover { background: rgba(255,255,255,0.05); color: #e6eef8; }
    
    /* SMS24h Specific Grid items colors */
    .svc-wa { color: #25D366; } /* WhatsApp */
    .svc-tg { color: #229ED9; } /* Telegram */
    .svc-go { color: #EA4335; } /* Google */
    .svc-fb { color: #1877F2; } /* Facebook */
    .svc-ig { color: #E1306C; } /* Instagram */
    .svc-lf { color: #000000; } /* TikTok (light) */
    body.dark .svc-lf { color: #ffffff; } /* TikTok (dark) */

    /* Toast Notifications */
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background: var(--card); border-left: 4px solid var(--accent); padding: 12px 16px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; pointer-events: auto; min-width: 250px; color: var(--text); font-size: 14px; }
    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    .toast.info { border-left-color: var(--accent); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* SMS Visual Improvements */
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
    .status-badge.waiting { background: rgba(255, 193, 7, 0.15); color: #d48806; border: 1px solid rgba(255, 193, 7, 0.3); }
    .status-badge.received { background: rgba(23, 177, 105, 0.15); color: var(--success); border: 1px solid rgba(23, 177, 105, 0.3); }
    .status-badge.error { background: rgba(255, 77, 79, 0.15); color: var(--danger); border: 1px solid rgba(255, 77, 79, 0.3); }
    
    @keyframes pulse-yellow {
      0% { box-shadow: 0 0 0 0 rgba(212, 136, 6, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(212, 136, 6, 0); }
      100% { box-shadow: 0 0 0 0 rgba(212, 136, 6, 0); }
    }
    .status-badge.waiting { animation: pulse-yellow 2s infinite; }

    .sms-progress-track { width: 100%; height: 6px; background: rgba(0,0,0,0.06); border-radius: 3px; margin-top: 8px; overflow: hidden; position: relative; }
    .sms-progress-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 1s linear; }

    .goal-bar-bg { background: rgba(0,0,0,0.05); height: 14px; border-radius: 7px; overflow: hidden; margin-top: 8px; position: relative; }
    .goal-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); width: 0%; transition: width 1s ease; border-radius: 7px; }
</style>
</head>
<body>
  <div id="initialLoader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);z-index:9999;display:flex;flex-direction:column;gap:16px;align-items:center;justify-content:center;">
    <div class="spinner"></div>
    <div style="font-size:16px;color:var(--muted);font-weight:500">Carregando...</div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <div class="layout" style="display:none">
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside>
      <div class="brand">
        <label for="logoUpload" style="cursor: pointer;" title="Clique para alterar a logo">
          <img id="brandLogo" src="meu_logo.jpeg" alt="logo" />
        </label>
        <input type="file" id="logoUpload" accept="image/*" style="display: none;" />
        <div>
          <div style="display:flex;align-items:center;gap:6px">
            <h1 id="appTitleDisplay" style="font-size:18px;margin:0">Painel Financeiro</h1>
            <button id="editAppTitleBtn" class="btn ghost" style="padding:0 4px;font-size:12px;border:none;color:var(--muted);cursor:pointer" title="Editar nome do painel">‚úèÔ∏è</button>
          </div>
          <div class="muted" id="saveStatus">Seu controle r√°pido</div>
        </div>
      </div>

      <nav>
        <div class="nav-item" data-view="dashboard">üè† Dashboard</div>
        <div class="nav-item" data-view="gastos">üí∏ Gastos</div>
        <div class="nav-item" data-view="plataformas">üñ•Ô∏è Plataformas</div>
        <div class="nav-item" data-view="dados">üë§ CPFs</div>
        <div class="nav-item" data-view="sms">üì± SMS</div>
        <div class="nav-item" data-view="fintech">üè¶ Fintech</div>
        <div class="nav-item" data-view="notasPendentes">
          <span>üìù Notas Pendentes</span>
          <span id="navPendingBadge" class="notes-badge" style="position:static;display:none">0</span>
        </div>
        <div class="nav-item" data-view="admin" id="navAdmin" style="display:none">üõ°Ô∏è Admin</div>
      </nav>

      <div class="section-title">Cria√ß√£o de conta</div>
      <div class="add-platform-wrapper" style="margin-top:0;margin-bottom:10px">
        <input id="newPlatformName" placeholder="Nova plataforma..." />
        <button class="btn" id="addPlatformBtn" title="Adicionar">+</button>
      </div>

      <div class="section-title">Plataformas</div>
      <input type="text" id="searchPlatforms" placeholder="üîé Buscar plataforma..." style="width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 8px; border: 1px solid #e6edf6; background: #fbfdff;">
      <div class="platforms-list" id="platformsList"></div>
      <div class="nav-item" id="logoutBtn" style="margin-top: 10px; color: var(--danger); flex-shrink: 0;">
        üö™ Sair
      </div>
    </aside>

    <main>
      <header class="top">
        <div class="header-left">
          <button id="mobileMenuBtn">‚ò∞</button>
          <div>
            <h2 id="pageTitle" style="margin:0">Dashboard</h2>
            <div class="muted">Sincroniza√ß√£o autom√°tica com a nuvem</div>
          </div>
        </div>
        <div class="header-right">
          <div class="header-actions">
            <div class="muted">Lucro Total</div>
            <button id="importDataHeaderBtn" class="btn ghost" style="padding:6px 10px">Importar dados</button>
            <button id="toggleTheme" class="btn ghost" style="padding:6px 10px">Tema</button>
          </div>
          <div style="font-size:20px;font-weight:700" id="lucroTotalDisplay">R$ 0,00</div>
        </div>
      </header>

      <div class="cards">
        <div class="card">
          <h3>Total de Contas</h3>
          <p id="totalContas">0</p>
        </div>
        <div class="card">
          <h3>Lucro Bruto (R$)</h3>
          <p id="lucroBruto">0.00</p>
        </div>
        <div class="card">
          <h3>Gastos (Proxy + N√∫meros)</h3>
          <p id="gastosTotal">0.00</p>
        </div>

        <div class="card">
          <h3 id="lucroMesTitle">Lucro do M√™s (Dias Fechados)</h3>
          <p id="lucroTotalDias">0.00</p>
        </div>

        <div class="card">
          <h3>CPFs Dispon√≠veis</h3>
          <p id="cpfsDisponiveis">0</p>
        </div>
    </div>

      <!-- Dashboard panel -->
      <div class="panel" id="dashboardPanel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <h3 style="margin:0">Vis√£o geral</h3>
            <div class="muted">Resumo por plataforma</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label for="sortPlatforms" class="muted" style="margin:0">Ordenar por:</label>
            <select id="sortPlatforms" style="padding:8px;border-radius:8px;border:1px solid #e5e7eb">
              <option value="name">Nome</option>
              <option value="profit">Lucro</option>
              <option value="date">Data (mais recente)</option>
            </select>
          </div>
        </div>
        <table id="summaryTable">
          <thead>
            <tr><th>Plataforma</th><th>Contas</th><th>Lucro</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- KPIs Dashboard -->
        <div style="margin-top:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0">üìä An√°lise Mensal</h3>
            <div>
              <button class="btn ghost active" id="showKpiBtn">Indicadores</button>
              <button class="btn ghost" id="showChartBtn">Gr√°fico</button>
            </div>
          </div>

          <!-- Monthly Goal Widget -->
          <div style="background:var(--card); padding:16px; border-radius:10px; border:1px solid #e6edf6; margin-bottom:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0; font-size:14px;">üéØ Meta Mensal: <span id="goalTargetDisplay" style="color:var(--accent); cursor:pointer;" title="Clique para alterar">R$ 0,00</span></h4>
                <span id="goalPercentDisplay" style="font-weight:700; font-size:14px;">0%</span>
            </div>
            <div class="goal-bar-bg"><div id="goalBarFill" class="goal-bar-fill"></div></div>
            <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:11px; color:var(--muted);"><span id="goalCurrentDisplay">Atual: R$ 0,00</span><span id="goalRemainingDisplay">Falta: R$ 0,00</span></div>
          </div>

          <div id="kpiContainer">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
              <div style="background:var(--card);padding:16px;border-radius:10px;border-left:4px solid var(--accent);">
                <div class="muted" style="font-size:12px;margin-bottom:4px">üìà M√©dia Di√°ria</div>
                <div style="font-size:22px;font-weight:700" id="kpiMediaDiaria">R$ 0,00</div>
              </div>

              <div style="background:var(--card);padding:16px;border-radius:10px;border-left:4px solid var(--success);">
                <div class="muted" style="font-size:12px;margin-bottom:4px">üèÜ Melhor Dia</div>
                <div style="font-size:14px;font-weight:600;color:var(--success)" id="kpiMelhorDia">-</div>
                <div style="font-size:18px;font-weight:700;margin-top:4px" id="kpiMelhorDiaValor">R$ 0,00</div>
              </div>

              <div style="background:var(--card);padding:16px;border-radius:10px;border-left:4px solid var(--danger);">
                <div class="muted" style="font-size:12px;margin-bottom:4px">üíî Pior Dia</div>
                <div style="font-size:14px;font-weight:600;color:var(--danger)" id="kpiPiorDia">-</div>
                <div style="font-size:18px;font-weight:700;margin-top:4px" id="kpiPiorDiaValor">R$ 0,00</div>
              </div>

              <div style="background:var(--card);padding:16px;border-radius:10px;border-left:4px solid #9ca3af;">
                <div class="muted" style="font-size:12px;margin-bottom:4px">üóìÔ∏è Total de Dias</div>
                <div style="font-size:22px;font-weight:700" id="kpiTotalDias">0</div>
              </div>

              <div style="background:var(--card);padding:16px;border-radius:10px;border-left:4px solid var(--accent);">
                <div class="muted" style="font-size:12px;margin-bottom:4px">üéØ Taxa de Sucesso</div>
                <div style="font-size:22px;font-weight:700" id="kpiTaxaSucesso">0%</div>
                <div class="muted" style="font-size:11px;margin-top:2px">dias com lucro positivo</div>
              </div>

              <div style="background:var(--card);padding:16px;border-radius:10px;border-left:4px solid #9ca3af;">
                <div class="muted" style="font-size:12px;margin-bottom:4px">üí∞ Lucro M√©dio/Conta</div>
                <div style="font-size:22px;font-weight:700" id="kpiLucroMedioConta">R$ 0,00</div>
              </div>
            </div>
          </div>

          <div id="chartContainer" style="display:none; background:var(--card); padding:16px; border-radius:10px; height: 350px;">
            <canvas id="dailyProfitChart"></canvas>
          </div>
        </div>

        <!-- Controle di√°rio / filtro -->
        <div class="daily-box">
          <h3>Controle Di√°rio</h3>
          
          <div style="display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.03);padding:8px 12px;border-radius:8px;margin-bottom:16px;border:1px solid rgba(0,0,0,0.05)">
            <button class="btn ghost" id="btnPrevMonth" style="font-size:18px;padding:4px 12px;min-width:40px">‚Äπ</button>
            <span id="displayMonthYear" style="font-weight:600;font-size:15px;text-transform:capitalize">M√™s Ano</span>
            <button class="btn ghost" id="btnNextMonth" style="font-size:18px;padding:4px 12px;min-width:40px">‚Ä∫</button>
          </div>

          <div style="display:flex;gap:12px;align-items:center;margin-top:10px">
            <label for="diaSelecionado" class="muted" style="margin-right:6px">Dia do m√™s</label>
            <select id="diaSelecionado" style="padding:8px;border-radius:8px;border:1px solid #e5e7eb">
              <option value="">Selecione o dia</option>
            </select>

            <button class="btn" id="fecharDiaBtn">Fechar Dia</button>
            <button class="btn ghost danger" id="limparHistoricoBtn">Limpar Hist√≥rico</button>
          </div>

          <h4 style="margin-top:16px">Hist√≥rico Di√°rio</h4>
          <table id="tabelaDias">
            <thead>
              <tr>
                <th>Data</th>
                <th>Lucro Bruto</th>
                <th>Gastos</th>
                <th>Lucro L√≠quido</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Gastos -->
      <div class="panel" id="gastosPanel" style="display:none">
        <h3>Despesas Operacionais</h3>
        <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:150px">
            <label>Gastos com Proxy (R$)</label>
            <input type="text" inputmode="decimal" id="gastoProxy" value="0" />
          </div>
          <div style="flex:1;min-width:150px">
            <label>Gastos com N√∫meros (SMS24h)</label>
            <input type="text" inputmode="decimal" id="gastoNumeros" value="0" />
          </div>
          <div style="flex:1;min-width:150px">
            <label>Gastos China SMS (R$)</label>
            <input type="text" inputmode="decimal" id="gastoChinaSms" value="0" />
          </div>
          <div style="flex:1;min-width:150px">
            <label>Gastos com Bot (R$)</label>
            <input type="text" inputmode="decimal" id="gastoBot" value="0" />
          </div>
        </div>
        <div style="margin-top:12px" class="muted">Os valores s√£o subtra√≠dos do lucro total automaticamente.</div>
      </div>

      <!-- Plataformas -->
      <div class="panel" id="plataformasPanel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div>
            <h3 id="plataformaTitle">Plataformas</h3>
            <div class="muted">Selecione uma plataforma na lateral ou crie uma nova.</div>
          </div>
          <div style="display:flex;gap:8px">
            <input type="text" id="searchAccounts" placeholder="üîç Buscar conta..." style="padding:8px;width:200px;border-radius:8px;border:1px solid #e6edf6">
            <button class="btn" id="addContaBtn">+ Adicionar Conta</button>
          </div>
        </div>

        <!-- Platform Summary -->
        <div id="platformSummary" style="display:none;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:12px;margin-bottom:20px;background:rgba(0,0,0,0.02);padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.05)">
            <!-- Injected by JS -->
        </div>

        <table id="contasTable">
          <thead>
            <tr>
              <th class="small">Conta</th>
              <th>Nome</th>
              <th class="small">Dep√≥sito (R$)</th>
              <th class="small">Re-dep√≥sito (R$)</th>
              <th class="small">Saque (R$)</th>
              <th class="small">Ba√∫ (R$)</th>
              <th>Lucro (R$)</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot></tfoot>
        </table>
      </div>

      <!-- Dados -->
      <div class="panel" id="dadosPanel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <div>
            <h3>Gerenciador de CPFs</h3>
            <div class="muted">Armazene e gerencie CPFs para as contas</div>
          </div>
          <button class="btn" id="addNotaBtn">+ Adicionar CPF</button>
        </div>

        <div style="background:var(--card);padding:16px;border-radius:10px;margin-bottom:20px;border:1px solid #e6edf6">
          <h4 style="margin:0 0 10px 0;font-size:15px">Importa√ß√£o em Massa</h4>
          <textarea id="bulkImportArea" placeholder="Cole aqui m√∫ltiplos CPFs (um por linha)&#10;Exemplo:&#10;123.456.789-00&#10;987.654.321-00&#10;111.222.333-44" style="width:100%;min-height:120px;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;font-size:13px;resize:vertical"></textarea>
          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btn" id="bulkImportBtn">Importar CPFs</button>
            <button class="btn ghost" id="removeUsedBtn">Remover CPFs Usados</button>
          </div>
        </div>

        <div id="notasList"></div>

        <!-- Backup Section -->
        <div style="margin-top: 24px; border-top: 1px solid #e6edf6; padding-top: 18px;">
            <h3>Backup e Transfer√™ncia</h3>
            <div class="muted">Exporte seus dados para usar em outro dispositivo (ex: celular).</div>
            <div style="display:flex; gap: 10px; margin-top: 12px;">
                <button class="btn" id="btnExportData">‚¨áÔ∏è Baixar Dados (Backup)</button>
                <button class="btn ghost" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Carregar Dados</button>
                <input type="file" id="importFile" style="display:none" accept=".json" />
            </div>
        </div>
      </div>

      <!-- Fintech -->
      <div class="panel" id="fintechPanel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <div>
            <h3>Fintech Otanpay (25%)</h3>
            <div class="muted">Gerencie contas Fintech com desconto de 25% nos saques</div>
          </div>
          <button class="btn" id="addFintechBtn">+ Adicionar Conta</button>
        </div>

        <table id="fintechTable">
          <thead>
            <tr>
              <th>Nome da Conta</th>
              <th>Saque (R$)</th>
              <th>Valor Final (75%)</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div style="margin: 30px 0; border-top: 1px solid #e6edf6;"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <div>
            <h3>Fintech Organpay (10%)</h3>
            <div class="muted">Gerencie contas Fintech com desconto de 10% nos saques</div>
          </div>
          <button class="btn" id="addFintech10Btn">+ Adicionar Conta</button>
        </div>

        <table id="fintechTable10">
          <thead>
            <tr>
              <th>Nome da Conta</th>
              <th>Saque (R$)</th>
              <th>CPFs (R$ 0,49)</th>
              <th>Valor Final (90%)</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div style="margin-top:20px;padding:16px;background:var(--card);border-radius:10px;border:1px solid #e6edf6">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span style="font-weight:500">Total Fintech Geral (ap√≥s descontos):</span>
            <span style="font-size:18px;font-weight:600;color:var(--success)" id="fintechTotal">R$ 0,00</span>
          </div>
        </div>
      </div>

      <!-- SMS Panel -->
      <div class="panel" id="smsPanel" style="display:none">
        <h3>Gerenciador de SMS</h3>
        
        <!-- Provider Selection -->
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="card provider-card selected" onclick="selectSmsProvider('sms24h')" id="card-sms24h" style="cursor:pointer; border: 2px solid transparent; padding: 16px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                <h4 style="margin:0; color:var(--accent); font-size:16px;">SMS24h.org</h4>
                <div class="muted" style="font-size:12px; margin-top:4px;">API Internacional</div>
            </div>
            <div class="card provider-card" onclick="selectSmsProvider('chinasms')" id="card-chinasms" style="cursor:pointer; border: 2px solid transparent; padding: 16px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                <h4 style="margin:0; color:var(--accent); font-size:16px;">China SMS</h4>
                <div class="muted" style="font-size:12px; margin-top:4px;">Bot Privado</div>
            </div>
        </div>

        <div id="sms24hContainer">
            <!-- Sub-tabs for SMS24h -->
            <div style="margin-bottom: 16px; display: flex; gap: 10px; border-bottom: 1px solid #e6edf6; padding-bottom: 8px;">
                <button class="btn ghost active" id="btnSms24hActivation" onclick="switchSmsSubTab('sms24h', 'activation')" style="border:none; border-bottom: 2px solid var(--accent); border-radius: 0;">üì± Nova Ativa√ß√£o</button>
                <button class="btn ghost" id="btnSms24hConfig" onclick="switchSmsSubTab('sms24h', 'config')" style="border:none; border-bottom: 2px solid transparent; border-radius: 0; color: var(--muted);">‚öôÔ∏è Configura√ß√£o API</button>
            </div>

            <!-- API Settings View -->
            <div id="sms24hConfigView" style="display:none">
                <div class="card" style="padding: 16px; margin-bottom: 20px;">
                    <h4>Configura√ß√µes da API (sms24h.org)</h4>
                    <div class="field">
                        <label for="smsApiKey">API Key</label>
                        <div style="display:flex; gap:8px;">
                            <input type="password" id="smsApiKey" placeholder="Cole sua API Key aqui" style="flex:1">
                            <button class="btn" id="saveSmsApiKey" style="white-space: nowrap;">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activation View -->
            <div id="sms24hActivationView">
                <div class="card" style="padding: 16px; margin-bottom: 20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <h4 style="margin:0">Nova Ativa√ß√£o</h4>
                            <div id="smsBalance" style="font-weight: 700; font-size: 18px; color: var(--success); background: rgba(23, 177, 105, 0.1); padding: 4px 8px; border-radius: 6px;">R$ --,--</div>
                            <button class="btn ghost" onclick="checkExpiredActivations()" style="padding: 4px 8px; font-size: 12px;" title="Sincronizar status e verificar expira√ß√£o">üîÑ Sincronizar</button>
                            <button class="btn ghost" id="checkSmsBalance" style="padding: 4px 8px; font-size: 12px;" title="Atualizar Saldo">üîÑ</button>
                        </div>
                        <button id="sms24hBackBtn" class="btn ghost" style="display:none; font-size:12px; padding: 4px 8px;" onclick="renderSmsServices()">‚¨Ö Voltar</button>
                    </div>
                    <div id="sms24hSelectionArea">
                        <!-- Grid injected by JS -->
                    </div>
                </div>
            </div>
        </div> <!-- End sms24hContainer -->

        <div id="chinaSmsContainer" style="display:none">
            <!-- Sub-tabs for ChinaSMS -->
            <div style="margin-bottom: 16px; display: flex; gap: 10px; border-bottom: 1px solid #e6edf6; padding-bottom: 8px;">
                <button class="btn ghost active" id="btnChinaSmsActivation" onclick="switchSmsSubTab('chinaSms', 'activation')" style="border:none; border-bottom: 2px solid var(--accent); border-radius: 0;">üì± Nova Ativa√ß√£o</button>
                <button class="btn ghost" id="btnChinaSmsConfig" onclick="switchSmsSubTab('chinaSms', 'config')" style="border:none; border-bottom: 2px solid transparent; border-radius: 0; color: var(--muted);">‚öôÔ∏è Configura√ß√£o API</button>
            </div>

            <!-- API Settings View -->
            <div id="chinaSmsConfigView" style="display:none">
                <div class="card" style="padding: 16px; margin-bottom: 20px;">
                    <h4>Configura√ß√µes da API (ChinaSMS Bot)</h4>
                    <div class="field">
                        <label for="chinaSmsToken">Token do Telegram</label>
                        <div style="display:flex; gap:8px;">
                            <input type="password" id="chinaSmsToken" placeholder="Cole seu token do bot aqui" style="flex:1">
                            <button class="btn" id="saveChinaSmsToken">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activation View -->
            <div id="chinaSmsActivationView">
                <div class="card" style="padding: 16px; margin-bottom: 20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <h4 style="margin:0">Nova Ativa√ß√£o</h4>
                            <div id="chinaSmsBalance" style="font-weight: 700; font-size: 18px; color: var(--success); background: rgba(23, 177, 105, 0.1); padding: 4px 8px; border-radius: 6px;">R$ --,--</div>
                            <button class="btn ghost" onclick="checkExpiredActivations()" style="padding: 4px 8px; font-size: 12px;" title="Sincronizar status e verificar expira√ß√£o">üîÑ Sincronizar</button>
                            <button class="btn ghost" id="checkChinaSmsBalance" style="padding: 4px 8px; font-size: 12px;" title="Atualizar Saldo">üîÑ</button>
                        </div>
                        <button id="chinaSmsBackBtn" class="btn ghost" style="display:none; font-size:12px; padding: 4px 8px;" onclick="renderChinaSmsServices()">‚¨Ö Voltar</button>
                    </div>
                    <div id="chinaSmsSelectionArea">
                        <!-- Content injected by JS -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Shared Active/History Section (Moved outside specific containers) -->
        <div id="smsSharedContainer" style="margin-top: 20px;">
            <!-- SMS Tabs -->
            <div class="sms-tabs">
                <button class="sms-tab-btn active" id="tabSmsActive" onclick="switchSmsTab('active')">Ativas</button>
                <button class="sms-tab-btn" id="tabSmsHistory" onclick="switchSmsTab('history')">Hist√≥rico</button>
            </div>
            
            <div style="display:flex; justify-content:flex-end; align-items:center; gap:15px; margin-bottom: 10px; padding: 0 4px;">
                <button id="btnEnableNotif" class="btn ghost" style="font-size:11px; padding:4px 8px; display:none" onclick="requestNotificationPermission()">üîî Ativar Notifica√ß√µes</button>
                
                <label style="display:flex; align-items:center; gap:6px; font-size:12px; cursor:pointer; color:var(--muted);">
                    <input type="checkbox" id="soundToggle" onchange="toggleSound(this.checked)" style="width:auto; margin:0;"> üîä Som
                </label>

                <label style="display:flex; align-items:center; gap:6px; font-size:12px; cursor:pointer; color:var(--muted);">
                    <input type="checkbox" id="autoCopyToggle" onchange="toggleAutoCopy(this.checked)" style="width:auto; margin:0;"> üìã Auto-copiar
                </label>
            </div>

            <!-- Active Activations Container -->
            <div id="smsActiveContainer">
                <div id="smsActivationsList"></div>
            </div>

            <!-- History Container -->
            <div id="smsHistoryContainer" style="display:none;">
                <div style="display:flex; justify-content:flex-end; margin-bottom:8px"><button class="btn ghost" onclick="clearSmsHistory()" style="font-size:11px">Limpar Hist√≥rico</button></div>
                <div id="smsHistoryList" style="max-height: 400px; overflow-y: auto; background: var(--card); border-radius: 8px; border: 1px solid #e6edf6;"></div>
            </div>
        </div>
      </div>

      <!-- Admin Panel -->
      <div class="panel" id="adminPanel" style="display:none">
        <h3>Administra√ß√£o de Usu√°rios</h3>
        <div class="muted">Gerencie as solicita√ß√µes de cadastro</div>
        
        <h4 style="margin-top:20px">Solicita√ß√µes Pendentes</h4>
        <div id="pendingUsersList"></div>

        <h4 style="margin-top:24px">Usu√°rios Ativos</h4>
        <div id="activeUsersList"></div>

        <h4 style="margin-top:24px">üìú Log de Atividades</h4>
        <div class="muted" style="margin-bottom:8px">Hist√≥rico de acessos recentes ao painel</div>
        <div id="activityLogsList" style="max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.02); padding: 10px; border-radius: 8px; border: 1px solid var(--muted);"></div>
        <button class="btn ghost" style="margin-top:8px;font-size:12px" onclick="clearActivityLogs()">Limpar Hist√≥rico</button>
      </div>

      <!-- Notas Pendentes -->
      <div class="panel" id="notasPendentesPanel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <div>
            <h3>Notas Pendentes</h3>
            <div class="muted">Notas preservadas de dias fechados</div>
          </div>
        </div>
        <div id="pendingNotesList"></div>
      </div>

      <footer>
        <span class="muted">v<span id="appVersionDisplay">1.0</span> ‚Ä¢ Dados salvos na nuvem (Supabase).</span>
      </footer>
    </main>
  </div>

  <!-- Generic Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="confirmModalTitle">Confirma√ß√£o</h3>
        <span class="close-modal" id="closeConfirmModal">&times;</span>
      </div>
      <p id="confirmModalText" style="margin: 16px 0; line-height: 1.6;"></p>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:24px;">
        <button class="btn ghost" id="confirmCancelBtn">Cancelar</button>
        <button class="btn" id="confirmOkBtn">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Generic Prompt Modal -->
  <div id="promptModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="promptModalTitle">Entrada</h3>
        <span class="close-modal" id="closePromptModal">&times;</span>
      </div>
      <p id="promptModalText" style="margin: 0 0 10px 0; color: var(--muted);"></p>
      <input type="text" id="promptInput" autocomplete="off">
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:24px;">
        <button class="btn ghost" id="promptCancelBtn">Cancelar</button>
        <button class="btn" id="promptOkBtn">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Move Account Modal -->
  <div id="moveAccountModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Mover Conta</h3>
        <span class="close-modal" id="closeMoveModal">&times;</span>
      </div>
      <p class="muted" style="margin-bottom:12px">Selecione a plataforma de destino:</p>
      <div id="moveTargetList" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto"></div>
    </div>
  </div>

  <!-- Overlay de Aprova√ß√£o Pendente -->
  <div id="pendingAccessOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:2000; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px;">
    <div style="font-size:48px; margin-bottom:20px;">‚è≥</div>
    <h2>Cadastro em An√°lise</h2>
    <p class="muted" style="max-width:400px; margin-bottom:30px; line-height:1.5;">Sua conta foi criada com sucesso, mas precisa ser aprovada pelo administrador para acessar o painel.</p>
    <button class="btn" id="checkAccessBtn">Verificar Novamente</button>
    <button class="btn ghost" id="pendingLogoutBtn" style="margin-top:10px;">Sair</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <!-- Modal de Notas -->
  <div id="notesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Notas da Conta</h3>
        <span class="close-modal" id="closeNotesModal">&times;</span>
      </div>
      <div id="accountNotesList" class="notes-container">
        <!-- Notas aparecer√£o aqui -->
      </div>
      <div class="add-note-box">
        <input type="text" id="newAccountNote" placeholder="Escrever nova nota..." style="flex:1">
        <button class="btn" id="saveAccountNoteBtn">Adicionar</button>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('load', function() {
      // --- CONFIGURA√á√ÉO DO SUPABASE ---
      const SUPABASE_URL = 'https://jljufumckmhfohnanaot.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsanVmdW1ja21oZm9obmFuYW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDg3MTUsImV4cCI6MjA4NzM4NDcxNX0.2Vod5MSgHIZToDVKmE1Pk1tE9itn2VRaqOHezDjl5Z4';
      
      let supabase;
      try {
        if (!window.supabase || !window.Chart || !window.Sortable) throw new Error('Uma ou mais bibliotecas externas (Supabase, Chart.js) n√£o foram carregadas.');
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      } catch (err) {
        document.body.innerHTML = `<div style="color:#e74c3c;text-align:center;padding:40px;font-family:sans-serif"><h3>Erro Cr√≠tico de Conex√£o</h3><p>${err.message}</p><p>Verifique sua conex√£o com a internet, desative bloqueadores de an√∫ncio e recarregue a p√°gina.</p><button onclick="location.reload()" style="padding:10px 20px;cursor:pointer">Recarregar</button></div>`;
        console.error('Falha cr√≠tica ao iniciar:', err);
        return; // Para a execu√ß√£o do script
      }

    // --- CONFIGURA√á√ÉO DO ADMIN ---
    const ADMIN_EMAIL = atob('d3JsaW5rbHVhbmFkbWluQGdtYWlsLmNvbQ=='); 

    let currentUserEmail = '';
    
    const APP_VERSION = '1.2'; // Mude este n√∫mero quando atualizar o site

    // --- App state (agora com dailyRecords)
    let state = { platforms: {}, platformOrder: [], brandLogo: null, appTitle: 'Painel Financeiro', gastoProxy:0, gastoNumeros:0, gastoBot:0, selectedPlatform: null, dailyRecords: {}, notas: [], fintechAccounts: [], fintechAccounts10: [], pendingNotes: [], smsApiKey: null, smsActivations: [], favoriteSmsServices: [], smsHistory: [], chinaSmsToken: null, currentSmsProvider: 'sms24h', autoCopySms: false, soundEnabled: true, monthlyGoal: 5000 };
    let saveTimer = null;

    // --- Utils
    function money(v){
      return Number(v || 0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
    }

    function parseDecimal(value) {
      if (typeof value === 'number') return value;
      if (typeof value !== 'string') return 0;
      return Number(value.replace(',', '.')) || 0;
    }

    function formatDateKey(year, month, day){
      // month is 1-12, pad to 2
      const mm = String(month).padStart(2,'0');
      const dd = String(day).padStart(2,'0');
      return `${year}-${mm}-${dd}`;
    }

    // --- Load / Save
    async function loadData(){
      // Verifica sess√£o no Supabase
      const { data: { session } } = await supabase.auth.getSession();
      
      if(!session) {
        window.location.href = 'login.html';
        return;
      }

      currentUserEmail = session.user.email;
      const displayUser = currentUserEmail.split('@')[0]; // Mostra s√≥ o nome antes do @
      const logoutBtn = document.getElementById('logoutBtn');
      if(logoutBtn) logoutBtn.innerHTML = `üö™ Sair <small style="opacity:0.7">(${displayUser})</small>`;

      // Busca dados da nuvem
      const { data, error } = await supabase
        .from('user_data')
        .select('content')
        .eq('user_id', session.user.id)
        .single();

      if(data && data.content){
        state = data.content;
      } else {
        // √â um usu√°rio novo, cria um registro pendente zerado.
        state = { 
            platforms: {}, 
            platformOrder: [], 
            brandLogo: null, 
            appTitle: 'Painel Financeiro', 
            gastoProxy:0, 
            gastoNumeros:0, 
            gastoBot:0, 
            gastoChinaSms:0,
            selectedPlatform: null, 
            dailyRecords: {}, 
            notas: [], 
            fintechAccounts: [], 
            fintechAccounts10: [],
            pendingNotes: [],
            smsApiKey: null, 
            smsActivations: [],
            favoriteSmsServices: [],
            chinaSmsToken: null,
            smsHistory: [],
            currentSmsProvider: 'sms24h',
            soundEnabled: true,
            autoCopySms: false,
            monthlyGoal: 5000,
            status: 'pending' // Novos usu√°rios come√ßam como pendentes
        };
        await saveData(); // Salva imediatamente para aparecer no Admin
      }

      if (state.brandLogo) {
        const logoEl = document.getElementById('brandLogo');
        if (logoEl) logoEl.src = state.brandLogo;
      }

      if (!state.appTitle) state.appTitle = 'Painel Financeiro';
      const titleEl = document.getElementById('appTitleDisplay');
      if(titleEl) titleEl.textContent = state.appTitle;

      // Se for o admin, mostra a aba Admin
      if(currentUserEmail.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
        document.getElementById('navAdmin').style.display = 'flex';
      }
      
      // --- VERIFICA√á√ÉO DE APROVA√á√ÉO ---
      if (state.status === 'pending' && currentUserEmail.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
        document.getElementById('initialLoader').style.display = 'none';
        document.getElementById('pendingAccessOverlay').style.display = 'flex';
        document.getElementById('checkAccessBtn').onclick = () => location.reload();
        document.getElementById('pendingLogoutBtn').onclick = async () => {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        };
        return; // Para a execu√ß√£o aqui, n√£o carrega o resto do painel
      }

      document.getElementById('initialLoader').style.display = 'none';
      document.querySelector('.layout').style.display = 'flex';

      // ensure dailyRecords exists
      if(!state.dailyRecords) state.dailyRecords = {};
      if(!state.notas) state.notas = [];
      if(!state.fintechAccounts) state.fintechAccounts = [];
      if(!state.fintechAccounts10) state.fintechAccounts10 = [];
      if(!state.smsApiKey) state.smsApiKey = null;
      if(!state.smsActivations) state.smsActivations = [];
      if(!state.favoriteSmsServices) state.favoriteSmsServices = [];
      if(!state.chinaSmsToken) state.chinaSmsToken = null;
      if(!state.currentSmsProvider) state.currentSmsProvider = 'sms24h';
      if(state.autoCopySms === undefined) state.autoCopySms = false;
      if(state.soundEnabled === undefined) state.soundEnabled = true;
      if(!state.smsHistory) state.smsHistory = [];
      if(!state.monthlyGoal) state.monthlyGoal = 5000;
      if(!state.pendingNotes) state.pendingNotes = [];
      if(!state.platformOrder || state.platformOrder.length !== Object.keys(state.platforms).length) {
        // Rebuild order if it's missing or out of sync
        state.platformOrder = Object.keys(state.platforms);
        scheduleSave();
      }

      // Update version display
      const vDisplay = document.getElementById('appVersionDisplay');
      if(vDisplay) vDisplay.textContent = APP_VERSION;
      
      updateUI();
      selectView('dashboard');
    }

    async function saveData(){
      const status = document.getElementById('saveStatus');
      if(status) status.textContent = '‚òÅÔ∏è Sincronizando...';

      try {
        const { data: { session } } = await supabase.auth.getSession();
        if(session) {
            state.savedBy = session.user.email; // Salva o email para identifica√ß√£o no Admin
            await supabase.from('user_data').upsert({ 
                user_id: session.user.id, 
                content: state 
            });
        }
        if(status) {
          status.textContent = '‚úì Salvo';
          setTimeout(()=> { if(status) status.textContent = 'Salvamento autom√°tico'; }, 2000);
        }
      } catch(e) {
        console.error('Erro ao salvar:', e);
        if(status) status.textContent = '‚ö†Ô∏è Erro ao salvar!';
      }
    }

    function saveDataImmediate(){
      if(saveTimer) clearTimeout(saveTimer);
      saveData();
    }

    function scheduleSave(){
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{ saveData(); }, 2000);
    }

    // --- UI Renderers
    function renderPlatformsList(){
      const container = document.getElementById('platformsList');
      container.innerHTML='';
      const searchTerm = document.getElementById('searchPlatforms').value.toLowerCase();

      const platformOrder = state.platformOrder || Object.keys(state.platforms);

      const filteredOrder = platformOrder.filter(pName => 
        state.platforms[pName] && state.platforms[pName].name.toLowerCase().includes(searchTerm)
      );

      filteredOrder.forEach(pName => {
        const p = state.platforms[pName];
        if (!p) return;

        const el = document.createElement('div');
        el.className = 'platform-card';
        el.dataset.platformName = p.name;
        if (p.name === state.selectedPlatform) {
          el.classList.add('selected');
        }
        el.innerHTML = `
          <div class="name">${p.name}</div>
          <div class="details">
            <div class="count">${p.accounts.length} contas</div>
            <div class="actions">
              <button class="btn ghost btn-edit-plat" title="Renomear">‚úèÔ∏è</button>
              <button class="btn ghost btn-delete" title="Remover plataforma">üóëÔ∏è</button>
            </div>
          </div>
        `;
        
        el.onclick = (e) => {
          if (e.target.closest('button')) return;
          selectPlatform(p.name);
        };
        el.querySelector('.btn-edit-plat').onclick = (e) => {
            e.stopPropagation();
            const oldName = pName; // Use the key from the loop, which is stable.
            
            showPrompt('Novo nome para a plataforma:', (newName) => {
                if(newName && newName.trim() !== '' && newName !== oldName) {
                    if(state.platforms[newName]) return showToast('J√° existe uma plataforma com este nome.', 'error');
                    
                    // Correctly rename by re-assigning the object and deleting the old key
                    const platformData = state.platforms[oldName];
                    platformData.name = newName;
                    
                    state.platforms[newName] = platformData;
                    delete state.platforms[oldName];
                    
                    const idx = state.platformOrder.indexOf(oldName);
                    if(idx !== -1) state.platformOrder[idx] = newName;
                    
                    if(state.selectedPlatform === oldName) {
                        state.selectedPlatform = newName;
                    }
                    
                    saveDataImmediate();
                    updateUI();
                }
            }, oldName);
        };
        el.querySelector('.btn-delete').onclick = () => {
          showConfirm(`Tem certeza que deseja remover a plataforma <strong>"${p.name}"</strong> e todas as suas contas? <br><br>Esta a√ß√£o n√£o pode ser desfeita.`, () => {
              delete state.platforms[p.name];
              const index = state.platformOrder.indexOf(p.name);
              if (index > -1) {
                state.platformOrder.splice(index, 1);
              }
              if(state.selectedPlatform === p.name) {
                state.selectedPlatform = state.platformOrder[0] || null;
                if (!state.selectedPlatform) { selectView('dashboard'); }
              }
              saveDataImmediate();
              updateUI();
          }, { isDanger: true, title: 'Remover Plataforma' });
        };
        container.appendChild(el);
      });
    }

    function renderSummary(){
      const tbody = document.querySelector('#summaryTable tbody'); tbody.innerHTML='';
      let totalAccounts=0, totalLucro=0;
      
        const sortBy = document.getElementById('sortPlatforms')?.value || 'name';
  
        const platformsData = Object.values(state.platforms).map(p => {
        const lucroPlat = p.accounts.reduce((s,a)=>
        s + (((a.saque||0) + (a.bau||0)) - ((a.deposito||0)+(a.redeposito||0))), 0);
        return {
        platform: p,
        name: p.name,
      lucro: lucroPlat,
createdAt: p.createdAt || new Date().toISOString()
      };
      });
        
          if(sortBy === 'name') {
          platformsData.sort((a, b) => a.name.localeCompare(b.name));
        } else if(sortBy === 'profit') {
        platformsData.sort((a, b) => b.lucro - a.lucro);
      } else if(sortBy === 'date') {
platformsData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      }
      
platformsData.forEach(data => {
      const p = data.platform;
      const lucroPlat = data.lucro;
      totalAccounts += p.accounts.length;
      totalLucro += lucroPlat;
const tr = document.createElement('tr');
      const lucroClass = lucroPlat >= 0 ? 'lucro' : 'negative';
      tr.innerHTML = `<td>${p.name}</td><td>${p.accounts.length}</td><td class="${lucroClass}">R$ ${money(lucroPlat)}</td>`;
      tbody.appendChild(tr);
      });

      let totalFintech = 0;
      if(state.fintechAccounts){
        state.fintechAccounts.forEach(acc => {
          const saque = Number(acc.saque) || 0;
          totalFintech += saque * 0.75;
        });
      }
      if(state.fintechAccounts10){
        state.fintechAccounts10.forEach(acc => {
          const saque = Number(acc.saque) || 0;
          const cpf = Number(acc.cpfCount) || 0;
          totalFintech += (saque * 0.90) - (cpf * 0.49);
        });
      }
      totalLucro += totalFintech;
      
      document.getElementById('totalContas').textContent = totalAccounts;
      
        const lucroBrutoEl = document.getElementById('lucroBruto');
        const lucroBrutoClass = totalLucro >= 0 ? 'lucro' : 'negative';
        lucroBrutoEl.textContent = money(totalLucro);
      lucroBrutoEl.className = lucroBrutoClass;

      const gastos = Number(state.gastoProxy||0) + Number(state.gastoNumeros||0) + Number(state.gastoBot||0) + Number(state.gastoChinaSms||0);
      const gastosTotalEl = document.getElementById('gastosTotal');
      gastosTotalEl.textContent = money(gastos);
      gastosTotalEl.className = 'negative';
        
      const lucroFinal = totalLucro - gastos;
    const lucroTotalDisplayEl = document.getElementById('lucroTotalDisplay');
    const lucroFinalClass = lucroFinal >= 0 ? 'lucro' : 'negative';
    lucroTotalDisplayEl.textContent = `R$ ${money(lucroFinal)}`;
    lucroTotalDisplayEl.className = lucroFinalClass;

    let somaDias = 0;
    const filteredRecords = getFilteredRecords();
    Object.values(filteredRecords || {}).forEach(r => { somaDias += Number(r && r.lucroLiquido ? r.lucroLiquido : 0); });
    const lucroTotalDiasEl = document.getElementById('lucroTotalDias');
    if(lucroTotalDiasEl) {
    const somaDiasClass = somaDias >= 0 ? 'lucro' : 'negative';
    lucroTotalDiasEl.textContent = `R$ ${money(somaDias)}`;
    lucroTotalDiasEl.className = somaDiasClass;
    }
    
    const cpfsDisponiveis = state.notas.filter(n => !n.used).length;
    const cpfsDisponiveisEl = document.getElementById('cpfsDisponiveis');
    if(cpfsDisponiveisEl) {
    cpfsDisponiveisEl.textContent = cpfsDisponiveis;
    }
    }

    function updatePlatformTotals() {
        const platform = state.selectedPlatform;
        if(!platform || !state.platforms[platform]) return;
        
        const accounts = state.platforms[platform].accounts;
        const searchTerm = document.getElementById('searchAccounts') ? document.getElementById('searchAccounts').value.toLowerCase() : '';
        
        let totalDep = 0, totalRedep = 0, totalSaque = 0, totalBau = 0, totalLucro = 0;
        let visibleCount = 0;
        
        accounts.forEach(acc => {
            if(searchTerm && !acc.name.toLowerCase().includes(searchTerm)) return;
            visibleCount++;
            const lucro = ((acc.saque||0) + (acc.bau||0)) - ((acc.deposito||0) + (acc.redeposito||0));
            totalDep += Number(acc.deposito)||0;
            totalRedep += Number(acc.redeposito)||0;
            totalSaque += Number(acc.saque)||0;
            totalBau += Number(acc.bau)||0;
            totalLucro += lucro;
        });

        // Update Summary
        const summaryEl = document.getElementById('platformSummary');
        if(summaryEl) {
            summaryEl.innerHTML = `
            <div style="text-align:center"><div class="muted" style="font-size:11px">Contas Vis√≠veis</div><div style="font-weight:700;font-size:16px">${visibleCount}</div></div>
            <div style="text-align:center"><div class="muted" style="font-size:11px">Investimento</div><div style="font-weight:700;font-size:16px;color:var(--danger)">R$ ${money(totalDep + totalRedep)}</div></div>
            <div style="text-align:center"><div class="muted" style="font-size:11px">Retorno (Saque+Ba√∫)</div><div style="font-weight:700;font-size:16px;color:var(--success)">R$ ${money(totalSaque + totalBau)}</div></div>
            <div style="text-align:center"><div class="muted" style="font-size:11px">Lucro L√≠quido</div><div style="font-weight:700;font-size:16px;color:${totalLucro>=0?'var(--success)':'var(--danger)'}">R$ ${money(totalLucro)}</div></div>
            `;
        }

        // Update Footer
        const tfoot = document.querySelector('#contasTable tfoot');
        if(tfoot) {
            tfoot.innerHTML = '';
            const tr = document.createElement('tr');
            tr.style.background = 'rgba(0,0,0,0.02)';
            tr.style.fontWeight = '700';
            tr.innerHTML = `
            <td colspan="2" style="text-align:right">Totais:</td>
            <td>R$ ${money(totalDep)}</td>
            <td>R$ ${money(totalRedep)}</td>
            <td>R$ ${money(totalSaque)}</td>
            <td>R$ ${money(totalBau)}</td>
            <td class="${totalLucro>=0?'lucro':'negative'}">R$ ${money(totalLucro)}</td>
            <td></td>
            `;
            tfoot.appendChild(tr);
        }
    }

    function renderContas(){
      const tbody = document.querySelector('#contasTable tbody'); 
      const tfoot = document.querySelector('#contasTable tfoot');
      tbody.innerHTML='';
      if(tfoot) tfoot.innerHTML = '';

      const platform = state.selectedPlatform;
      if(!platform || !state.platforms[platform]) {
          document.getElementById('platformSummary').style.display = 'none';
          return;
      }
      
      document.getElementById('platformSummary').style.display = 'grid';
      const accounts = state.platforms[platform].accounts;
      const searchTerm = document.getElementById('searchAccounts') ? document.getElementById('searchAccounts').value.toLowerCase() : '';

      accounts.forEach((acc,i)=>{
        if(!acc.name) acc.name = '';
        if(searchTerm && !acc.name.toLowerCase().includes(searchTerm)) return; // Filtro de busca
        
        const notesCount = acc.notes ? acc.notes.length : 0;

        const tr = document.createElement('tr');
        const lucro = ((acc.saque||0) + (acc.bau||0)) - ((acc.deposito||0) + (acc.redeposito||0));
        
        const lucroClass = lucro >= 0 ? 'lucro' : 'negative';
        tr.innerHTML = `
          <td>${i+1}</td>
          <td><input type="text" class="inp inp-name" value="${acc.name||''}" placeholder="Nome da conta" style="width:160px;padding:8px;border-radius:6px;border:1px solid #e6edf6" /></td>
          <td><input type="text" inputmode="decimal" class="inp deposito" value="${String(acc.deposito||0).replace('.',',')}" style="width:180px;padding:8px;font-size:14px" /></td>
          <td><input type="text" inputmode="decimal" class="inp redeposito" value="${String(acc.redeposito||0).replace('.',',')}" style="width:180px;padding:8px;font-size:14px" /></td>
          <td><input type="text" inputmode="decimal" class="inp saque" value="${String(acc.saque||0).replace('.',',')}" style="width:180px;padding:8px;font-size:14px" /></td>
          <td><input type="text" inputmode="decimal" class="inp bau" value="${String(acc.bau||0).replace('.',',')}" style="width:180px;padding:8px;font-size:14px" /></td>
          <td class="${lucroClass} lucro-cell">R$ ${money(lucro)}</td>
          <td class="actions" style="display:flex;gap:4px;justify-content:flex-end">
            <div class="btn-notes-container">
              <button class="btn ghost btn-notes">üìù</button>
              ${notesCount > 0 ? `<span class="notes-badge">${notesCount}</span>` : ''}
            </div>
            <button class="btn ghost del">X</button>
          </td>
        `;
        const lucroCell = tr.querySelector('.lucro-cell');

        tr.querySelector('.inp-name').addEventListener('input', (e)=>{
          state.platforms[platform].accounts[i].name = e.target.value;
          scheduleSave();
        });

        tr.querySelectorAll('.inp:not(.inp-name)').forEach((input)=>{
        input.addEventListener('input', (e)=>{
            const rowIdx = i;
            const row = state.platforms[platform].accounts[rowIdx];
            row.deposito = parseDecimal(tr.querySelector('.deposito').value);
            row.redeposito = parseDecimal(tr.querySelector('.redeposito').value);
            row.saque = parseDecimal(tr.querySelector('.saque').value);
            row.bau = parseDecimal(tr.querySelector('.bau').value);
            const newLucro = ((row.saque||0) + (row.bau||0)) - ((row.deposito||0) + (row.redeposito||0));
            const newLucroClass = newLucro >= 0 ? 'lucro' : 'negative';
            lucroCell.textContent = `R$ ${money(newLucro)}`;
            lucroCell.className = `${newLucroClass} lucro-cell`;
            scheduleSave();
            updatePlatformTotals();
        });
        input.addEventListener('blur', ()=>{
            renderSummary();
            renderDiasTabela();
        });
        input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.target.blur(); } });
    });
        
        tr.querySelector('.btn-notes').onclick = () => { openNotesModal(platform, i); };
        tr.querySelector('.del').onclick = ()=>{ 
          showConfirm('Tem certeza que deseja remover esta conta?', () => {
            state.platforms[platform].accounts.splice(i,1); scheduleSave(); renderContas(); renderPlatformsList(); renderSummary(); renderDiasTabela(); 
          }, { isDanger: true, title: 'Remover Conta' });
        };

        tbody.appendChild(tr);
      });

      updatePlatformTotals();
    }

    function renderDiasTabela(){
      const tbody = document.querySelector("#tabelaDias tbody");
      if(!tbody) return;
      tbody.innerHTML = "";

      const records = getFilteredRecords();
      const keys = Object.keys(records).sort((a,b)=> b.localeCompare(a));
      keys.forEach(dateKey=>{
        const r = records[dateKey];
        // Format date to DD/MM/YYYY
        const [year, month, day] = dateKey.split('-');
        const formattedDate = `${day}/${month}/${year}`;

        const tr = document.createElement("tr");
        const lucroBrutoClass = r.lucroBruto >= 0 ? 'lucro' : 'negative';
        const lucroLiquidoClass = r.lucroLiquido >= 0 ? 'lucro' : 'negative';
        
        tr.innerHTML = `
          <td style="font-weight:500">${formattedDate}</td>
          <td class="${lucroBrutoClass}">R$ ${money(r.lucroBruto)}</td>
          <td class="negative">R$ ${money(r.gastos)}</td>
          <td class="${lucroLiquidoClass}">R$ ${money(r.lucroLiquido)}</td>
          <td class="actions"><button class="btn ghost del-day">X</button></td>
        `;

        tr.querySelector('.del-day').addEventListener('click', () => {
          showConfirm(`Deseja realmente excluir o registro do dia <strong>${dateKey}</strong>?<br><br>Lucro L√≠quido: R$ ${money(r.lucroLiquido)}<br><br>Esta a√ß√£o n√£o pode ser desfeita.`, () => {
              delete state.dailyRecords[dateKey];
              saveDataImmediate();
              renderDiasTabela();
              renderSummary();
              renderKPIs();
              renderDailyProfitChart();
          }, { isDanger: true, title: 'Excluir Registro do Dia' });
        });

        tbody.appendChild(tr);
      });
    }

    function renderKPIs(){
      const records = Object.values(getFilteredRecords() || {});

      if(records.length === 0){
        document.getElementById('kpiMediaDiaria').textContent = 'R$ 0,00';
        document.getElementById('kpiMelhorDia').textContent = '-';
        document.getElementById('kpiMelhorDiaValor').textContent = 'R$ 0,00';
        document.getElementById('kpiPiorDia').textContent = '-';
        document.getElementById('kpiPiorDiaValor').textContent = 'R$ 0,00';
        document.getElementById('kpiTotalDias').textContent = '0';
        document.getElementById('kpiTaxaSucesso').textContent = '0%';
        document.getElementById('kpiLucroMedioConta').textContent = 'R$ 0,00';
        return;
      }

      const totalLucro = records.reduce((sum, r) => sum + (r.lucroLiquido || 0), 0);
      const mediaDiaria = totalLucro / records.length;

      let melhorDia = null;
      let piorDia = null;
      let melhorValor = -Infinity;
      let piorValor = Infinity;

      const diasPositivos = records.filter(r => (r.lucroLiquido || 0) > 0).length;
      const taxaSucesso = (diasPositivos / records.length) * 100;

      const filtered = getFilteredRecords();
      Object.keys(filtered).forEach(dateKey => {
        const r = filtered[dateKey];
        const lucro = r.lucroLiquido || 0;

        if(lucro > melhorValor){
          melhorValor = lucro;
          melhorDia = dateKey;
        }

        if(lucro < piorValor){
          piorValor = lucro;
          piorDia = dateKey;
        }
      });

      let totalContas = 0;
      Object.values(state.platforms).forEach(p => {
        totalContas += p.accounts.length;
      });
      const lucroMedioConta = totalContas > 0 ? totalLucro / totalContas : 0;

      document.getElementById('kpiMediaDiaria').textContent = `R$ ${money(mediaDiaria)}`;
      document.getElementById('kpiMelhorDia').textContent = melhorDia || '-';
      document.getElementById('kpiMelhorDiaValor').textContent = `R$ ${money(melhorValor === -Infinity ? 0 : melhorValor)}`;
      document.getElementById('kpiPiorDia').textContent = piorDia || '-';
      document.getElementById('kpiPiorDiaValor').textContent = `R$ ${money(piorValor === Infinity ? 0 : piorValor)}`;
      document.getElementById('kpiTotalDias').textContent = records.length;
      document.getElementById('kpiTaxaSucesso').textContent = `${Math.round(taxaSucesso)}%`;
      document.getElementById('kpiLucroMedioConta').textContent = `R$ ${money(lucroMedioConta)}`;
      
      renderMonthlyGoal(totalLucro);
    }

    function renderMonthlyGoal(currentProfit) {
        const goal = state.monthlyGoal || 5000;
        const percent = Math.min(100, Math.max(0, (currentProfit / goal) * 100));
        
        const targetDisplay = document.getElementById('goalTargetDisplay');
        const percentDisplay = document.getElementById('goalPercentDisplay');
        const barFill = document.getElementById('goalBarFill');
        const currentDisplay = document.getElementById('goalCurrentDisplay');
        const remainingDisplay = document.getElementById('goalRemainingDisplay');

        if(targetDisplay) targetDisplay.textContent = `R$ ${money(goal)}`;
        if(percentDisplay) percentDisplay.textContent = `${percent.toFixed(1)}%`;
        if(barFill) barFill.style.width = `${percent}%`;
        if(currentDisplay) currentDisplay.textContent = `Atual: R$ ${money(currentProfit)}`;
        
        const remaining = Math.max(0, goal - currentProfit);
        if(remainingDisplay) remainingDisplay.textContent = remaining > 0 ? `Falta: R$ ${money(remaining)}` : 'Meta batida! üéâ';
    }

    document.getElementById('goalTargetDisplay')?.addEventListener('click', () => {
        showPrompt('Definir nova meta mensal (R$):', (val) => {
            const newGoal = parseDecimal(val);
            if(newGoal > 0) {
                state.monthlyGoal = newGoal;
                saveDataImmediate();
                renderKPIs(); // Re-render to update goal
            }
        }, state.monthlyGoal);
    });

    function updateUI(){
      // Sincroniza os inputs de gastos com o estado, garantindo que a UI reflita o state
      const gp = document.getElementById('gastoProxy');
      const gn = document.getElementById('gastoNumeros');
      const gb = document.getElementById('gastoBot');
      const gcs = document.getElementById('gastoChinaSms');
      if(gp) gp.value = String(state.gastoProxy || 0).replace('.',',');
      if(gn) gn.value = String(state.gastoNumeros || 0).replace('.',',');
      if(gb) gb.value = String(state.gastoBot || 0).replace('.',',');
      if(gcs) gcs.value = String(state.gastoChinaSms || 0).replace('.',',');

      renderPlatformsList();
      renderSummary();
      renderContas();
      renderDiasTabela();
      renderKPIs();
      renderNotas();
      renderFintech();
      renderPendingNotes();
      renderSmsPanel();
      // Adicionado para popular os servi√ßos do ChinaSMS na primeira carga
      renderChinaSmsServices();
      renderFilterHeader();
    }
    
    let dailyChart = null;

    // --- Actions
    function selectView(view){
      let title = view.charAt(0).toUpperCase()+view.slice(1);
      if (view === 'dados') {
        title = 'CPFs';
      }
      document.getElementById('pageTitle').textContent = title;

      const cardsContainer = document.querySelector('.cards');
      if(cardsContainer) cardsContainer.style.display = view==='dashboard'? 'flex' : 'none';

      document.getElementById('dashboardPanel').style.display = view==='dashboard'? 'block' : 'none';
      document.getElementById('gastosPanel').style.display = view==='gastos'? 'block' : 'none';
      document.getElementById('plataformasPanel').style.display = view==='plataformas'? 'block' : 'none';
      document.getElementById('dadosPanel').style.display = view==='dados'? 'block' : 'none';
      document.getElementById('fintechPanel').style.display = view==='fintech'? 'block' : 'none';
      document.getElementById('notasPendentesPanel').style.display = view==='notasPendentes'? 'block' : 'none';
      document.getElementById('smsPanel').style.display = view==='sms'? 'block' : 'none';
      document.getElementById('adminPanel').style.display = view==='admin'? 'block' : 'none';
      if(view === 'admin' && typeof renderAdminPanel === 'function') renderAdminPanel();

      if (view === 'sms') {
        fetchAndDisplaySmsPrices();
        if (!smsUiInterval) {
            renderSmsActivations();
            smsUiInterval = setInterval(renderSmsActivations, 1000);
        }
      } else {
        if (smsUiInterval) { clearInterval(smsUiInterval); smsUiInterval = null; }
      }
    }

    function selectPlatform(name){
      state.selectedPlatform = name; scheduleSave();
      // switch to platforms view
      selectView('plataformas');
      document.getElementById('plataformaTitle').textContent = name;
      updateUI();
    }

    // --- Event listeners (buttons, inputs)
    document.getElementById('addPlatformBtn').onclick = ()=>{
      const v = document.getElementById('newPlatformName').value.trim();
      if(!v) return showToast('Digite o nome da plataforma', 'error');
      if(state.platforms[v]) return showToast('Plataforma j√° existe', 'error');
      state.platforms[v] = {name:v, accounts:[], createdAt: new Date().toISOString()};
      if(!state.platformOrder) state.platformOrder = [];
      state.platformOrder.push(v);
      document.getElementById('newPlatformName').value='';
      scheduleSave(); updateUI();
      setTimeout(() => {
        const inp = document.getElementById('newPlatformName');
        if(inp) inp.focus();
      }, 100);
    };

    document.getElementById('addContaBtn').onclick = ()=>{
      const p = state.selectedPlatform || Object.keys(state.platforms)[0];
      if(!p) return showToast('Crie uma plataforma primeiro', 'error');
      state.platforms[p].accounts.push({deposito:0,redeposito:0,saque:0, bau:0});
      scheduleSave(); updateUI(); renderContas();
      setTimeout(() => {
        const firstInput = document.querySelector('#contasTable tbody tr:last-child .inp.deposito');
        if(firstInput) firstInput.focus();
      }, 100);
    }

    document.getElementById('searchAccounts')?.addEventListener('input', () => {
        renderContas();
    });

    document.getElementById('searchPlatforms').addEventListener('input', renderPlatformsList);

    document.querySelectorAll('nav .nav-item').forEach(it=>{
      it.addEventListener('click',()=>{ selectView(it.dataset.view); });
    });

    const sortDropdown = document.getElementById('sortPlatforms');
    if(sortDropdown) {
      sortDropdown.addEventListener('change', () => {
        renderSummary();
      });
    }

    document.getElementById('showKpiBtn').addEventListener('click', () => {
        document.getElementById('kpiContainer').style.display = 'block';
        document.getElementById('chartContainer').style.display = 'none';
        document.getElementById('showKpiBtn').classList.add('active');
        document.getElementById('showChartBtn').classList.remove('active');
    });

    document.getElementById('showChartBtn').addEventListener('click', () => {
        document.getElementById('kpiContainer').style.display = 'none';
        document.getElementById('chartContainer').style.display = 'block';
        document.getElementById('showChartBtn').classList.add('active');
        document.getElementById('showKpiBtn').classList.remove('active');
        renderDailyProfitChart(); // Render chart when shown
    });

    function renderDailyProfitChart() {
        const ctx = document.getElementById('dailyProfitChart').getContext('2d');
        if (!ctx) return;

        const isDark = document.body.classList.contains('dark');
        const textColor = isDark ? '#9ca3af' : '#6b7684';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)';

        const records = getFilteredRecords();
        const sortedKeys = Object.keys(records).sort((a, b) => a.localeCompare(b));

        const labels = sortedKeys.map(key => key.split('-')[2]); // Just the day
        const data = sortedKeys.map(key => records[key].lucroLiquido);

        const backgroundColors = data.map(value => value >= 0 ? 'rgba(23, 177, 105, 0.8)' : 'rgba(255, 77, 79, 0.8)');
        const hoverColors = data.map(value => value >= 0 ? 'rgba(23, 177, 105, 1)' : 'rgba(255, 77, 79, 1)');

        if (dailyChart) {
            dailyChart.destroy();
        }

        dailyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Lucro L√≠quido',
                    data: data,
                    backgroundColor: backgroundColors,
                    hoverBackgroundColor: hoverColors,
                    borderRadius: 4,
                    borderSkipped: false,
                    barPercentage: 0.6,
                    categoryPercentage: 0.8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: gridColor,
                            borderDash: [3, 3],
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: { family: "'Inter', sans-serif", size: 11 },
                            callback: function(value) { return value.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL', maximumFractionDigits: 0}); }
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: { family: "'Inter', sans-serif", size: 11 }
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: isDark ? '#2a2d33' : '#ffffff',
                        titleColor: isDark ? '#e6eef8' : '#17233b',
                        bodyColor: isDark ? '#e6eef8' : '#17233b',
                        borderColor: isDark ? '#333' : '#e6edf6',
                        borderWidth: 1,
                        padding: 12,
                        titleFont: { family: "'Inter', sans-serif", size: 13 },
                        bodyFont: { family: "'Inter', sans-serif", size: 13 },
                        callbacks: { label: (ctx) => `Lucro: R$ ${money(ctx.parsed.y)}` },
                        displayColors: false,
                        cornerRadius: 8,
                        boxPadding: 4
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                animation: {
                    duration: 800,
                    easing: 'easeOutQuart'
                }
            }
        });
    }

    document.getElementById('addNotaBtn').onclick = ()=>{
      state.notas.unshift({text:'', used: false, createdAt: new Date().toISOString()});
      scheduleSave();
      renderNotas();
    };

    // --- Backup Logic
    document.getElementById('btnExportData').addEventListener('click', () => { window.exportData(); });
    
    document.getElementById('importFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => { window.importData(ev.target.result); };
        reader.readAsText(file);
    });

    document.getElementById('importDataHeaderBtn').addEventListener('click', () => {
        document.getElementById('importFile').click();
    });

    function renderNotas(){
      const container = document.getElementById('notasList');
      if(!container) return;
      container.innerHTML = '';
      (state.notas || []).forEach((nota, i)=>{
        const card = document.createElement('div');
        card.className = 'note-card';
        if(nota.used) card.classList.add('used');

        const cpfText = document.createElement('div');
        cpfText.className = 'cpf-text';
        cpfText.textContent = nota.text || 'CPF n√£o informado';

        const rightSection = document.createElement('div');
        rightSection.style.display = 'flex';
        rightSection.style.alignItems = 'center';
        rightSection.style.gap = '8px';

        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'Copiar';
        copyBtn.className = 'btn ghost';
        copyBtn.style.padding = '4px 8px';
        copyBtn.onclick = () => {
          if(!nota.text) return;
          navigator.clipboard.writeText(nota.text).then(() => {
            state.notas[i].used = true;
            copyBtn.textContent = 'Copiado!';
            setTimeout(() => { copyBtn.textContent = 'Copiar'; }, 1500);
            
            saveDataImmediate();
            renderNotas();
            renderSummary();
          }).catch(err => {
            console.error('Falha ao copiar:', err);
            showToast('N√£o foi poss√≠vel copiar o texto.', 'error');
          });
        };

        const usedLabel = document.createElement('span');
        usedLabel.textContent = 'CPF usado';
        usedLabel.style.fontSize = '12px';
        usedLabel.style.color = 'var(--success)';
        usedLabel.style.fontWeight = '500';
        usedLabel.style.display = nota.used ? 'block' : 'none';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = nota.used || false;
        checkbox.addEventListener('change', ()=>{
          state.notas[i].used = checkbox.checked;
          saveDataImmediate();
          renderNotas();
          renderSummary();
        });

        rightSection.appendChild(copyBtn);
        rightSection.appendChild(usedLabel);
        rightSection.appendChild(checkbox);
        card.appendChild(cpfText);
        card.appendChild(rightSection);
        container.appendChild(card);
      });
    }

    document.getElementById('bulkImportBtn').addEventListener('click', async ()=>{
      const textarea = document.getElementById('bulkImportArea');
      const text = textarea.value.trim();
      if(!text) return showToast('Cole os CPFs no campo acima, um por linha.', 'error');

      const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
      if(lines.length === 0) return showToast('Nenhum CPF v√°lido encontrado.', 'error');

      lines.forEach(cpf => {
        state.notas.push({text: cpf, used: false, createdAt: new Date().toISOString()});
      });

      textarea.value = '';
      saveData();
      renderSummary();
      renderNotas();
      showToast(`${lines.length} CPF(s) importado(s) com sucesso!`, 'success');
    });

    document.getElementById('removeUsedBtn').addEventListener('click', ()=>{
      const usedCount = state.notas.filter(n => n.used).length;
      if(usedCount === 0) return showToast('Nenhum CPF marcado como usado.', 'info');
      
      showConfirm(`Remover <strong>${usedCount}</strong> CPF(s) marcado(s) como usado?`, () => {
        state.notas = state.notas.filter(n => !n.used);
        saveData();
        renderSummary();
        renderNotas();
      }, { isDanger: true, title: 'Remover CPFs Usados' });
    });

    function renderFintech(){
      const tbody = document.querySelector('#fintechTable tbody');
      const tbody10 = document.querySelector('#fintechTable10 tbody');
      if(!tbody || !tbody10) return;
      tbody.innerHTML = '';
      tbody10.innerHTML = '';

      let totalFinal = 0;

      // Render 25% Accounts
      state.fintechAccounts.forEach((acc, i) => {
        const saque = Number(acc.saque) || 0;
        const valorFinal = saque * 0.75;
        totalFinal += valorFinal;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" class="inp-name" value="${acc.name || ''}" placeholder="Nome da conta" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6edf6" /></td>
          <td><input type="text" inputmode="decimal" class="inp-saque" value="${String(saque).replace('.',',')}" style="width:120px;padding:8px;border-radius:6px;border:1px solid #e6edf6" /></td>
          <td class="valor-final lucro">R$ ${money(valorFinal)}</td>
          <td class="actions"><button class="btn ghost del-fintech">X</button></td>
        `;

        tr.querySelector('.inp-name').addEventListener('input', (e) => {
          state.fintechAccounts[i].name = e.target.value;
          scheduleSave();
        });

        tr.querySelector('.inp-saque').addEventListener('input', (e) => {
          const newSaque = parseDecimal(e.target.value);
          state.fintechAccounts[i].saque = newSaque;

          const newValorFinal = newSaque * 0.75;
          const valorFinalCell = tr.querySelector('.valor-final');
          valorFinalCell.textContent = `R$ ${money(newValorFinal)}`;

          updateFintechTotal();
          scheduleSave();
          renderSummary();
        });

        tr.querySelector('.del-fintech').addEventListener('click', () => {
          showConfirm('Tem certeza que deseja remover esta conta Fintech?', () => {
              state.fintechAccounts.splice(i, 1);
              scheduleSave();
              renderFintech();
              renderSummary();
          }, { isDanger: true, title: 'Remover Conta Fintech' });
        });

        tbody.appendChild(tr);
      });

      // Render 10% Accounts
      state.fintechAccounts10.forEach((acc, i) => {
        const saque = Number(acc.saque) || 0;
        const cpfCount = Number(acc.cpfCount) || 0;
        const valorFinal = (saque * 0.90) - (cpfCount * 0.49);
        totalFinal += valorFinal;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" class="inp-name" value="${acc.name || ''}" placeholder="Nome da conta" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6edf6" /></td>
          <td><input type="text" inputmode="decimal" class="inp-saque" value="${String(saque).replace('.',',')}" style="width:120px;padding:8px;border-radius:6px;border:1px solid #e6edf6" /></td>
          <td><input type="number" class="inp-cpf" value="${cpfCount}" style="width:80px;padding:8px;border-radius:6px;border:1px solid #e6edf6" placeholder="Qtd" /></td>
          <td class="valor-final lucro">R$ ${money(valorFinal)}</td>
          <td class="actions"><button class="btn ghost del-fintech">X</button></td>
        `;

        tr.querySelector('.inp-name').addEventListener('input', (e) => {
          state.fintechAccounts10[i].name = e.target.value;
          scheduleSave();
        });

        tr.querySelector('.inp-saque').addEventListener('input', (e) => {
          const newSaque = parseDecimal(e.target.value);
          state.fintechAccounts10[i].saque = newSaque;

          const currentCpf = Number(state.fintechAccounts10[i].cpfCount) || 0;
          const newValorFinal = (newSaque * 0.90) - (currentCpf * 0.49);
          const valorFinalCell = tr.querySelector('.valor-final');
          valorFinalCell.textContent = `R$ ${money(newValorFinal)}`;

          updateFintechTotal();
          scheduleSave();
          renderSummary();
        });

        tr.querySelector('.inp-cpf').addEventListener('input', (e) => {
          const newCpf = Number(e.target.value) || 0;
          state.fintechAccounts10[i].cpfCount = newCpf;
          
          const currentSaque = Number(state.fintechAccounts10[i].saque) || 0;
          const newValorFinal = (currentSaque * 0.90) - (newCpf * 0.49);
          
          const valorFinalCell = tr.querySelector('.valor-final');
          valorFinalCell.textContent = `R$ ${money(newValorFinal)}`;

          updateFintechTotal();
          scheduleSave();
          renderSummary();
        });

        tr.querySelector('.del-fintech').addEventListener('click', () => {
          showConfirm('Tem certeza que deseja remover esta conta Fintech (10%)?', () => {
              state.fintechAccounts10.splice(i, 1);
              scheduleSave();
              renderFintech();
              renderSummary();
          }, { isDanger: true, title: 'Remover Conta Fintech' });
        });

        tbody10.appendChild(tr);
      });

      const totalEl = document.getElementById('fintechTotal');
      if(totalEl) totalEl.textContent = `R$ ${money(totalFinal)}`;
    }

    function updateFintechTotal() {
        let total = 0;
        state.fintechAccounts.forEach(acc => total += (Number(acc.saque)||0) * 0.75);
        state.fintechAccounts10.forEach(acc => {
            const s = Number(acc.saque)||0;
            const c = Number(acc.cpfCount)||0;
            total += (s * 0.90) - (c * 0.49);
        });
        const totalEl = document.getElementById('fintechTotal');
        if(totalEl) totalEl.textContent = `R$ ${money(total)}`;
    }

    document.getElementById('addFintechBtn').addEventListener('click', () => {
      state.fintechAccounts.push({ name: '', saque: 0 });
      scheduleSave();
      renderFintech();
    });

    document.getElementById('addFintech10Btn').addEventListener('click', () => {
      state.fintechAccounts10.push({ name: '', saque: 0 });
      scheduleSave();
      renderFintech();
    });

    // gastos inputs
    document.getElementById('gastoProxy').addEventListener('input', (e)=>{
      const val = parseDecimal(e.target.value);
      if(val < 0) {
        e.target.value = '0';
        showToast('Valores negativos n√£o s√£o permitidos', 'error');
        return;
      }
      state.gastoProxy = val;
      scheduleSave();
      renderSummary();
      renderDiasTabela();
    });

    document.getElementById('gastoNumeros').addEventListener('input', (e)=>{
      const val = parseDecimal(e.target.value);
      if(val < 0) {
        e.target.value = '0';
        showToast('Valores negativos n√£o s√£o permitidos', 'error');
        return;
      }
      state.gastoNumeros = val;
      scheduleSave();
      renderSummary();
      renderDiasTabela();
    });

    document.getElementById('gastoBot').addEventListener('input', (e)=>{
      const val = parseDecimal(e.target.value);
      if(val < 0) {
        e.target.value = '0';
        showToast('Valores negativos n√£o s√£o permitidos', 'error');
        return;
      }
      state.gastoBot = val;
      scheduleSave();
      renderSummary();
      renderDiasTabela();
    });

    document.getElementById('gastoChinaSms').addEventListener('input', (e)=>{
      const val = parseDecimal(e.target.value);
      if(val < 0) {
        e.target.value = '0';
        showToast('Valores negativos n√£o s√£o permitidos', 'error');
        return;
      }
      state.gastoChinaSms = val;
      scheduleSave();
      renderSummary();
      renderDiasTabela();
    });

    // fechar dia button (OP√á√ÉO B ‚Äî manual)
    document.getElementById('fecharDiaBtn').addEventListener('click', ()=>{
      const diaSel = document.getElementById('diaSelecionado').value;
      if(!diaSel){
        return showToast('Selecione o dia do m√™s que deseja fechar.', 'error');
      }

      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const day = Number(diaSel);
      const dateKey = formatDateKey(year, month, day);

      // Calcula o lucro bruto total, incluindo plataformas e fintech
      let totalLucroPlataformas = 0;
      Object.values(state.platforms).forEach(p=>{
        totalLucroPlataformas += p.accounts.reduce((s,a)=>
    s + (((a.saque||0) + (a.bau||0)) - ((a.deposito||0)+(a.redeposito||0))), 0);
      });

      let totalFintech = 0;
      if(state.fintechAccounts){
        state.fintechAccounts.forEach(acc => {
          totalFintech += (Number(acc.saque) || 0) * 0.75;
        });
      }
      if(state.fintechAccounts10){
        state.fintechAccounts10.forEach(acc => {
          const s = Number(acc.saque) || 0;
          const c = Number(acc.cpfCount) || 0;
          totalFintech += (s * 0.90) - (c * 0.49);
        });
      }

      const totalLucro = totalLucroPlataformas + totalFintech;
      const gastos = Number(state.gastoProxy||0) + Number(state.gastoNumeros||0) + Number(state.gastoBot||0) + Number(state.gastoChinaSms||0);
      const lucroFinal = totalLucro - gastos;

      const message = `Deseja fechar o dia <strong>${dateKey}</strong>?<br><br>
                       Lucro Bruto: R$ ${totalLucro.toFixed(2)}<br>
                       Gastos: R$ ${gastos.toFixed(2)}<br>
                       <strong>Lucro L√≠quido: R$ ${lucroFinal.toFixed(2)}</strong><br><br>
                       <strong style="color:var(--danger)">ATEN√á√ÉO:</strong> Todos os valores de plataformas, fintech e gastos ser√£o <strong>ZERADOS</strong>. Esta a√ß√£o √© irrevers√≠vel.`;

      showConfirm(message, () => {
          state.dailyRecords[dateKey] = {
            lucroBruto: totalLucro,
            gastos: gastos,
            lucroLiquido: lucroFinal,
            savedAt: new Date().toISOString()
          };

          // Mover notas existentes para a aba Notas Pendentes
          Object.values(state.platforms).forEach(p => {
            p.accounts.forEach(acc => {
              if (acc.notes && acc.notes.length > 0) {
                acc.notes.forEach(note => {
                  state.pendingNotes.push({
                    platform: p.name,
                    account: acc.name || 'Conta sem nome',
                    text: note,
                    date: dateKey,
                    savedAt: new Date().toISOString()
                  });
                });
              }
            });
          });

          state.gastoProxy = 0;
          state.gastoNumeros = 0;
          state.gastoBot = 0;
          state.gastoChinaSms = 0;
          state.platforms = {};
          state.platformOrder = [];
          state.selectedPlatform = null;
          state.fintechAccounts = [];
          state.fintechAccounts10 = [];
          saveDataImmediate();
          updateUI();
      }, { isDanger: true, title: 'Fechar o Dia e Zerar Contas?', okText: 'Sim, Fechar o Dia' });
    });

    // limpar hist√≥rico (opcional)
    document.getElementById('limparHistoricoBtn').addEventListener('click', ()=>{
      showConfirm('Deseja limpar <strong>TODO</strong> o hist√≥rico di√°rio? <br><br>Esta a√ß√£o √© irrevers√≠vel.', () => {
          state.dailyRecords = {};
          saveDataImmediate();
          updateUI();
      }, { isDanger: true, title: 'Limpar Hist√≥rico' });
    });

    // populate day select (1..31)
    function populateDaySelect(){
      const sel = document.getElementById('diaSelecionado');
      sel.innerHTML = '<option value="">Selecione o dia</option>';
      for(let i=1;i<=31;i++){
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = String(i);
        sel.appendChild(opt);
      }
    }

    // --- Filter Logic
    let filterDate = new Date();

    function getFilteredRecords() {
      const year = filterDate.getFullYear();
      const month = String(filterDate.getMonth() + 1).padStart(2, '0');
      const prefix = `${year}-${month}-`;
      
      const filtered = {};
      Object.keys(state.dailyRecords).forEach(key => {
        if(key.startsWith(prefix)) {
          filtered[key] = state.dailyRecords[key];
        }
      });
      return filtered;
    }

    function renderFilterHeader() {
      const el = document.getElementById('displayMonthYear');
      if(el) {
        const opt = { month: 'long', year: 'numeric' };
        el.textContent = filterDate.toLocaleDateString('pt-BR', opt);
      }
      const title = document.getElementById('lucroMesTitle');
      if(title) {
         const monthName = filterDate.toLocaleDateString('pt-BR', { month: 'long' });
         title.textContent = `Lucro de ${monthName.charAt(0).toUpperCase() + monthName.slice(1)} (Dias Fechados)`;
      }
    }

    document.getElementById('btnPrevMonth').addEventListener('click', () => {
      filterDate.setMonth(filterDate.getMonth() - 1);
      updateUI();
    });
    document.getElementById('btnNextMonth').addEventListener('click', () => {
      filterDate.setMonth(filterDate.getMonth() + 1);
      updateUI();
    });

    // --- Custom Modal Logic
    let confirmCallback = null;

    function showConfirm(message, onConfirm, {title = 'Confirma√ß√£o', okText = 'Confirmar', cancelText = 'Cancelar', isDanger = false, hideCancel = false} = {}) {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalText').innerHTML = message;
        
        const okBtn = document.getElementById('confirmOkBtn');
        const cancelBtn = document.getElementById('confirmCancelBtn');

        okBtn.textContent = okText;
        cancelBtn.textContent = cancelText;

        okBtn.classList.remove('danger');
        if (isDanger) okBtn.classList.add('danger');
        
        cancelBtn.style.display = hideCancel ? 'none' : 'block';

        confirmCallback = onConfirm;
        document.getElementById('confirmModal').style.display = 'block';
    }
    
    // Atalho para alertas simples (sem bot√£o cancelar)
    window.showAlert = (message, {title = 'Aviso', okText = 'OK'} = {}) => {
        showConfirm(message, null, {title, okText, cancelText: '', hideCancel: true});
    }

    function hideConfirm() {
        document.getElementById('confirmModal').style.display = 'none';
        confirmCallback = null;
    }

    document.getElementById('confirmOkBtn').addEventListener('click', () => {
        if (typeof confirmCallback === 'function') {
            confirmCallback();
        }
        hideConfirm();
    });
    document.getElementById('confirmCancelBtn').addEventListener('click', hideConfirm);
    document.getElementById('closeConfirmModal').addEventListener('click', hideConfirm);
    
    // --- Custom Prompt Logic
    let promptCallback = null;

    function showPrompt(message, onConfirm, defaultValue = '') {
        document.getElementById('promptModalTitle').textContent = 'Entrada de Dados';
        document.getElementById('promptModalText').textContent = message;
        const input = document.getElementById('promptInput');
        input.value = defaultValue;
        
        promptCallback = onConfirm;
        document.getElementById('promptModal').style.display = 'block';
        setTimeout(() => input.focus(), 100);
    }

    function hidePrompt() {
        document.getElementById('promptModal').style.display = 'none';
        promptCallback = null;
    }

    document.getElementById('promptOkBtn').addEventListener('click', () => {
        const val = document.getElementById('promptInput').value;
        if (typeof promptCallback === 'function') {
            promptCallback(val);
        }
        hidePrompt();
    });
    document.getElementById('promptCancelBtn').addEventListener('click', hidePrompt);
    document.getElementById('closePromptModal').addEventListener('click', hidePrompt);
    
    // Allow Enter key in prompt
    document.getElementById('promptInput').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') document.getElementById('promptOkBtn').click();
    });
    
    window.onclick = (event) => {
      if (event.target == document.getElementById('notesModal')) {
        document.getElementById('notesModal').style.display = 'none';
      }
      if (event.target == document.getElementById('confirmModal')) {
        hideConfirm();
      }
      if (event.target == document.getElementById('promptModal')) {
        hidePrompt();
      }
      if (event.target == document.getElementById('moveAccountModal')) {
        document.getElementById('moveAccountModal').style.display = 'none';
      }
    };
    // --- End Custom Modal Logic

    // --- Move Account Logic
    let accountToMoveIndex = null;
    
    window.openMoveModal = (index) => {
        accountToMoveIndex = index;
        const list = document.getElementById('moveTargetList');
        list.innerHTML = '';
        
        const currentPlat = state.selectedPlatform;
        const targets = (state.platformOrder || Object.keys(state.platforms)).filter(p => p !== currentPlat);
        
        if(targets.length === 0) {
            list.innerHTML = '<div class="muted">Nenhuma outra plataforma dispon√≠vel.</div>';
        }

        targets.forEach(pName => {
            const btn = document.createElement('button');
            btn.className = 'btn ghost';
            btn.style.textAlign = 'left';
            btn.style.border = '1px solid #e6edf6';
            btn.textContent = pName;
            btn.onclick = () => {
                const acc = state.platforms[currentPlat].accounts.splice(accountToMoveIndex, 1)[0];
                state.platforms[pName].accounts.push(acc);
                scheduleSave();
                document.getElementById('moveAccountModal').style.display = 'none';
                renderContas();
                renderPlatformsList();
                renderSummary();
                showToast(`Conta movida para ${pName}`, 'success');
            };
            list.appendChild(btn);
        });
        
        document.getElementById('moveAccountModal').style.display = 'block';
    };
    
    document.getElementById('closeMoveModal').onclick = () => {
        document.getElementById('moveAccountModal').style.display = 'none';
    };

    // --- Notas por Conta Logic
    let currentEditingAccount = { platform: null, index: null };

    function openNotesModal(platform, index) {
      currentEditingAccount = { platform, index };
      const acc = state.platforms[platform].accounts[index];
      if(!acc.notes) acc.notes = [];

      document.getElementById('modalTitle').textContent = `Notas: ${acc.name || 'Conta ' + (index + 1)}`;
      renderAccountNotes();
      document.getElementById('notesModal').style.display = 'block';
    }

    function renderAccountNotes() {
      const container = document.getElementById('accountNotesList');
      container.innerHTML = '';
      const acc = state.platforms[currentEditingAccount.platform].accounts[currentEditingAccount.index];

      if(!acc.notes || acc.notes.length === 0) {
        container.innerHTML = '<div class="muted" style="text-align:center;padding:20px">Nenhuma nota adicionada.</div>';
        return;
      }

      acc.notes.forEach((note, i) => {
        const div = document.createElement('div');
        div.className = 'note-item';
        div.innerHTML = `<span>${note}</span><button class="btn ghost" style="padding:2px 6px;color:var(--danger);border-color:transparent" onclick="deleteAccountNote(${i})">remover</button>`;
        container.appendChild(div);
      });
    }

    window.deleteAccountNote = (i) => {
      const acc = state.platforms[currentEditingAccount.platform].accounts[currentEditingAccount.index];
      acc.notes.splice(i, 1);
      scheduleSave();
      renderAccountNotes();
      renderContas();
    };

    document.getElementById('saveAccountNoteBtn').onclick = () => {
      const input = document.getElementById('newAccountNote');
      const text = input.value.trim();
      if(!text) return;

      const acc = state.platforms[currentEditingAccount.platform].accounts[currentEditingAccount.index];
      if(!acc.notes) acc.notes = [];
      acc.notes.push(text);

      input.value = '';
      scheduleSave();
      renderAccountNotes();
      renderContas();
    };

    document.getElementById('closeNotesModal').onclick = () => {
      document.getElementById('notesModal').style.display = 'none';
    };

    // --- Pending Notes Logic
    function renderPendingNotes(){
      const container = document.getElementById('pendingNotesList');
      if(!container) return;
      container.innerHTML = '';
      
      if(!state.pendingNotes || state.pendingNotes.length === 0) {
        container.innerHTML = '<div class="muted" style="text-align:center;padding:40px">Nenhuma nota pendente.</div>';
        updateSidebarBadge();
        return;
      }

      state.pendingNotes.forEach((note, i) => {
        const el = document.createElement('div');
        el.className = 'note-card';
        el.innerHTML = `
          <div style="flex:1">
            <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">
              <span style="color: var(--muted); font-weight: 500;">Usu√°rio:</span> ${note.account}
            </div>
            <div style="font-size:14px; color:var(--text); padding-left: 10px; border-left: 3px solid var(--accent); margin-bottom: 8px;">
              ${note.text}
            </div>
            <div style="font-size:12px; color:var(--muted);">
              <strong>${note.platform}</strong> ‚Ä¢ ${note.date}
            </div>
          </div>
          <button class="btn ghost" style="color:var(--danger);border-color:transparent" onclick="deletePendingNote(${i})">Resolver</button>
        `;
        container.appendChild(el);
      });
      
      updateSidebarBadge();
    }

    window.deletePendingNote = (i) => {
        showConfirm('Marcar nota como resolvida/remover?', () => {
            state.pendingNotes.splice(i, 1);
            scheduleSave();
            renderPendingNotes();
        }, { title: 'Resolver Nota' });
    };

    function updateSidebarBadge() {
        const count = state.pendingNotes ? state.pendingNotes.length : 0;
        const badge = document.getElementById('navPendingBadge');
        if(badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        }
    }

    // --- Admin Logic (Simplificado para Cloud: Desativado por enquanto)
    let adminUsersCache = []; // Cache para facilitar a aprova√ß√£o

    window.renderAdminPanel = async function() {
      const container = document.getElementById('adminPanel');
      if(!container) return;
      
      container.innerHTML = '<div class="muted">Carregando dados do servidor...</div>';

      // Busca todos os dados da tabela user_data
      const { data, error } = await supabase
        .from('user_data')
        .select('user_id, updated_at, content');

      if(error) {
        container.innerHTML = `
          <div style="color:var(--danger); padding:15px; border:1px solid var(--danger); border-radius:8px; background:rgba(255,0,0,0.05)">
            <strong>Erro de Permiss√£o:</strong> O Supabase bloqueou o acesso aos dados dos outros usu√°rios.<br><br>
            Para corrigir, v√° no <strong>SQL Editor</strong> do Supabase e rode este comando:<br>
            <code style="display:block; background:#000; color:#0f0; padding:10px; margin-top:10px; border-radius:4px; font-size:12px">
              create policy "Admin ve tudo" on user_data for select using (auth.jwt() ->> 'email' = 'wrlinkluanadmin@gmail.com');
            </code>
          </div>
        `;
        return;
      }

      adminUsersCache = data; // Salva para uso nas fun√ß√µes de aprovar

      const pendingUsers = data.filter(u => u.content && u.content.status === 'pending');
      const activeUsers = data.filter(u => !u.content || u.content.status !== 'pending');

      // Renderiza a lista
      container.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Administra√ß√£o</h3>
          <button class="btn ghost" onclick="renderAdminPanel()">üîÑ Atualizar Lista</button>
        </div>
        <div class="muted">Total de usu√°rios: <strong>${data.length}</strong></div>
        
        <h4 style="margin-top:20px; color:var(--accent)">‚è≥ Pendentes (${pendingUsers.length})</h4>
        <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px">
          ${pendingUsers.length === 0 ? '<div class="muted">Nenhuma solicita√ß√£o pendente.</div>' : ''}
          ${pendingUsers.map(row => {
            const email = (row.content && row.content.savedBy) ? row.content.savedBy : 'Email n√£o salvo (vers√£o antiga)';
            const lastUpdate = new Date(row.updated_at).toLocaleString('pt-BR');
            const plataformas = row.content && row.content.platforms ? Object.keys(row.content.platforms).length : 0;
            
            return `
              <div class="card" style="padding:12px; display:flex; justify-content:space-between; align-items:center">
                <div>
                  <div style="font-weight:600; font-size:15px">${email}</div>
                  <div class="muted" style="font-size:12px">ID: ${row.user_id}</div>
                  <div class="muted" style="font-size:12px">√öltima sincroniza√ß√£o: ${lastUpdate}</div>
                </div>
                <div style="display:flex; gap:8px;">
                  <button class="btn" onclick="approveUserCloud('${row.user_id}')">Aprovar</button>
                  <button class="btn danger" onclick="rejectUserCloud('${row.user_id}')">Reprovar</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        <h4 style="margin-top:24px; color:var(--success)">‚úÖ Ativos (${activeUsers.length})</h4>
        <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px">
          ${activeUsers.map(row => {
            const email = (row.content && row.content.savedBy) ? row.content.savedBy : 'Email n√£o salvo (antigo)';
            const lastUpdate = new Date(row.updated_at).toLocaleString('pt-BR');
            const plataformas = row.content && row.content.platforms ? Object.keys(row.content.platforms).length : 0;
            const isAdmin = email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            const adminTag = isAdmin ? ' <span style="color:var(--accent); font-size:12px; font-weight:600;">(Admin)</span>' : '';
            const deleteButton = !isAdmin ? `<button class="btn ghost danger" style="padding:6px 10px;font-size:12px" onclick="deleteUserCloud('${row.user_id}', '${email}')">Excluir</button>` : '';
            
            return `
              <div class="card" style="padding:12px; display:flex; justify-content:space-between; align-items:center">
                <div>
                  <div style="font-weight:600; font-size:15px">${email}${adminTag}</div>
                  <div class="muted" style="font-size:12px">ID: ${row.user_id}</div>
                  <div class="muted" style="font-size:12px">√öltima sincroniza√ß√£o: ${lastUpdate}</div>
                </div>
                <div style="display:flex;align-items:center;gap:10px">
                  <div class="muted">${plataformas} plataformas</div>
                  ${deleteButton}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    window.approveUserCloud = async (userId) => {
        const userRow = adminUsersCache.find(u => u.user_id === userId);
        if (!userRow) return;

        const newContent = { ...userRow.content, status: 'approved' };
        
        const { error } = await supabase.from('user_data').update({ content: newContent }).eq('user_id', userId);
        
        if (error) {
            showToast('Erro ao aprovar: ' + error.message, 'error');
        } else {
            showToast('Usu√°rio aprovado com sucesso!', 'success');
            renderAdminPanel();
        }
    };

    window.rejectUserCloud = async (userId) => {
        showConfirm('Tem certeza que deseja REPROVAR este usu√°rio? Isso excluir√° a solicita√ß√£o de cadastro.', async () => {
            const { error } = await supabase.from('user_data').delete().eq('user_id', userId);
            
            if (error) {
                showToast('Erro ao reprovar: ' + error.message, 'error');
            } else {
                showToast('Usu√°rio reprovado com sucesso!', 'success');
                renderAdminPanel();
            }
        }, { isDanger: true, title: 'Reprovar Usu√°rio' });
    };

    window.deleteUserCloud = async (userId, email) => {
        showConfirm(`ATEN√á√ÉO: Tem certeza que deseja EXCLUIR o usu√°rio "${email}"?\n\nIsso apagar√° todos os dados dele do banco de dados. Essa a√ß√£o n√£o pode ser desfeita.`, async () => {
            const { error } = await supabase.from('user_data').delete().eq('user_id', userId);
            
            if (error) {
                showToast('Erro ao excluir: ' + error.message, 'error');
            } else {
                showToast('Usu√°rio exclu√≠do com sucesso!', 'success');
                renderAdminPanel();
            }
        }, { isDanger: true, title: 'Excluir Usu√°rio' });
    };

    // --- Logout Logic (Bot√£o Sair)
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = 'login.html';
    });

    // --- Mobile Menu Logic
    const mobileBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.querySelector('aside');
    const overlay = document.getElementById('sidebarOverlay');

    function toggleSidebar() {
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
    }

    if(mobileBtn) mobileBtn.addEventListener('click', toggleSidebar);
    if(overlay) overlay.addEventListener('click', toggleSidebar);

    // Close sidebar when clicking a nav item on mobile
    document.querySelectorAll('nav .nav-item').forEach(it => {
      it.addEventListener('click', () => {
        if(window.innerWidth <= 900) {
          sidebar.classList.remove('open');
          overlay.classList.remove('open');
        }
      });
    });

    // --- SMS Logic ---
    const SMS_API_URL = 'https://api.sms24h.org/stubs/handler_api';
    const CORS_PROXY = 'https://corsproxy.io/?';
    const CHINA_SMS_API_URL = 'https://chinasmsbot.top/api';
    const CHINA_SMS_SERVICES = [
        { id: 'mercado', name: 'Mercado Pago', price: 0.80 },
        { id: 'mpsrv2', name: 'Mercado Pago S2', price: 0.95 },
        { id: 'mpsrv3', name: 'Mercado Pago S3', price: 0.90 },
        { id: 'mpsrv4', name: 'Mercado Pago S4', price: 0.80 },
        { id: 'nubanksrv1', name: 'Nubank S1', price: 1.0 },
        { id: 'nubank', name: 'Nubank S2', price: 0.9 },
        { id: 'nubanksrv3', name: 'Nubank S3', price: 1.75 },
        { id: 'nubanksrv4', name: 'Nubank S4', price: 1.68 },
        { id: 'outros', name: 'Outros', price: 0.9 },
        { id: 'srv2', name: 'Outros S2', price: 0.65 },
        { id: 'outrossrv3', name: 'Outros S3', price: 1.5 },
        { id: 'outrossrv4', name: 'Outros S4', price: 0.65 },
        { id: 'santander', name: 'Santander S1', price: 0.48 },
        { id: 'santandersrv2', name: 'Santander S2', price: 0.48 },
        { id: 'santandersrv3', name: 'Santander S3', price: 0.48 },
        { id: 'infinitepay', name: 'InfinitePay S1', price: 0.9 },
        { id: 'infinitepaysrv2', name: 'InfinitePay S2', price: 0.6 },
        { id: 'infinitepaysrv3', name: 'InfinitePay S3', price: 1.6 },
        { id: 'picpay', name: 'PicPay', price: 0.65 },
        { id: 'picsrv3', name: 'PicPay S3', price: 1.05 },
        { id: 'picsrv4', name: 'PicPay S4', price: 0.8 },
    ];
    const CHINA_SMS_GROUPS_MAP = {
        'mercadopago': { name: 'Mercado Pago', icon: 'ü§ù', ids: ['mercado', 'mpsrv2', 'mpsrv3', 'mpsrv4'] },
        'nubank': { name: 'Nubank', icon: 'üíú', ids: ['nubanksrv1', 'nubank', 'nubanksrv3', 'nubanksrv4'] },
        'santander': { name: 'Santander', icon: '‚ô®Ô∏è', ids: ['santander', 'santandersrv2', 'santandersrv3'] },
        'infinitepay': { name: 'InfinitePay', icon: '‚ôæÔ∏è', ids: ['infinitepay', 'infinitepaysrv2', 'infinitepaysrv3'] },
        'picpay': { name: 'PicPay', icon: 'üü©', ids: ['picpay', 'picsrv3', 'picsrv4'] },
        'outros': { name: 'Outros', icon: 'üåê', ids: ['outros', 'srv2', 'outrossrv3', 'outrossrv4'] }
    };
    // IDs dos servi√ßos que exigem espera de 2 minutos para cancelar (Server 1 e 3)
    const CHINA_SMS_RESTRICTED_CANCEL = [
        'mercado', 'mpsrv3', 'nubanksrv1', 'nubanksrv3', 'santander', 'santandersrv3', 
        'infinitepay', 'infinitepaysrv3', 'picpay', 'picsrv3', 'outros', 'outrossrv3'
    ];

    let smsPollingIntervals = {}; // To store setInterval IDs
    let smsUiInterval = null;
    let smsPricesCache = {};
    const SMS_SERVICES_LIST = [ // Pre√ßos manuais definidos
        { id: 'lj', name: 'Santander', manualPrice: 0.50, icon: '‚ô®Ô∏è' },
        { id: 'aaa', name: 'Nubank', manualPrice: 1.20, icon: 'üíú' },
        { id: 'anx', name: 'InfinitePay', manualPrice: 0.64, icon: '‚ôæÔ∏è' },
        { id: 'abg', name: 'PagBank', manualPrice: 0.40, icon: 'üí≥' },
        { id: 'aff', name: 'C6 Bank', manualPrice: 0.55, icon: '‚ö´' },
        { id: 'cq', name: 'Mercado Pago', manualPrice: 1.30, icon: 'ü§ù' },
        { id: 'ot', name: 'Outros', manualPrice: 0.70, icon: 'üåê' }
    ];

    // Helper para obter pre√ßo do servi√ßo para contabilidade autom√°tica
    function getServicePrice(provider, serviceId) {
        if (provider === 'chinasms') {
            const svc = CHINA_SMS_SERVICES.find(s => s.id === serviceId);
            return svc ? svc.price : 0;
        } else {
            // SMS24h
            const manualSvc = SMS_SERVICES_LIST.find(s => s.id === serviceId);
            if (manualSvc && manualSvc.manualPrice) return manualSvc.manualPrice;
            // Tenta cache
            if (smsPricesCache[serviceId]) return smsPricesCache[serviceId].price / 100;
            // Fallback gen√©rico
            return 1.00; 
        }
    }

    async function smsApiCall(params) {
        const apiKey = state.smsApiKey;
        if (!apiKey) {
            showToast('Por favor, insira e salve sua API Key do sms24h.org primeiro.', 'error');
            return null;
        }
        
        const queryString = new URLSearchParams({ api_key: apiKey, ...params }).toString();
        const url = `${SMS_API_URL}?${queryString}`;

        try {
            // Tenta conex√£o direta primeiro
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            return await response.text();
        } catch (error) {
            console.warn('Conex√£o direta falhou (prov√°vel CORS), tentando via proxy...', error);
            try {
                // Tenta via Proxy se a direta falhar
                const proxyUrl = `${CORS_PROXY}${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Proxy response was not ok');
                return await response.text();
            } catch (proxyError) {
                console.error('Erro fatal na API SMS:', proxyError);
                return null;
            }
        }
    }

    function renderSmsPanel() {
        const apiKeyInput = document.getElementById('smsApiKey');
        const chinaSmsTokenInput = document.getElementById('chinaSmsToken');
        if (apiKeyInput) apiKeyInput.value = state.smsApiKey || '';
        if (chinaSmsTokenInput) chinaSmsTokenInput.value = state.chinaSmsToken || '';
        
        // Renderiza a interface correta baseada no provedor selecionado
        // S√≥ chama selectSmsProvider se necess√°rio para evitar recarregar o saldo desnecessariamente
        const targetProvider = state.currentSmsProvider || 'sms24h';
        const currentCard = document.getElementById('card-' + targetProvider);
        if (!currentCard || !currentCard.classList.contains('selected')) {
            selectSmsProvider(targetProvider);
        }
        
        const autoCopyCheck = document.getElementById('autoCopyToggle');
        if(autoCopyCheck) {
            autoCopyCheck.checked = state.autoCopySms || false;
        }
        const soundCheck = document.getElementById('soundToggle');
        if(soundCheck) {
            soundCheck.checked = state.soundEnabled !== false;
        }
        
        if (Notification.permission === 'default') {
            document.getElementById('btnEnableNotif').style.display = 'block';
        }

        renderSmsActivations();
        renderSmsHistory();
    }

    function renderChinaSmsServices() {
        const container = document.getElementById('chinaSmsSelectionArea');
        const backBtn = document.getElementById('chinaSmsBackBtn');
        if (!container) return;
        
        if(backBtn) backBtn.style.display = 'none';
        container.innerHTML = '<div class="service-grid"></div>';
        const grid = container.querySelector('.service-grid');

        Object.keys(CHINA_SMS_GROUPS_MAP).forEach(key => {
            const group = CHINA_SMS_GROUPS_MAP[key];
            const el = document.createElement('div');
            el.className = 'service-item';
            el.innerHTML = `
                <div class="service-icon">${group.icon}</div>
                <div class="service-name">${group.name}</div>
            `;
            el.onclick = () => renderChinaSmsServers(key);
            grid.appendChild(el);
        });
    }
    // Expor fun√ß√£o para o bot√£o Voltar no HTML
    window.renderChinaSmsServices = renderChinaSmsServices;

    function renderChinaSmsServers(groupKey) {
        const container = document.getElementById('chinaSmsSelectionArea');
        const backBtn = document.getElementById('chinaSmsBackBtn');
        if (!container) return;

        if(backBtn) backBtn.style.display = 'block';
        const group = CHINA_SMS_GROUPS_MAP[groupKey];
        
        container.innerHTML = `<div class="muted" style="margin-bottom:8px">Servidores dispon√≠veis para <strong>${group.name}</strong>:</div><div class="server-list"></div>`;
        const list = container.querySelector('.server-list');

        group.ids.forEach(svcId => {
            const svc = CHINA_SMS_SERVICES.find(s => s.id === svcId);
            if (!svc) return;

            const el = document.createElement('div');
            el.className = 'server-item';
            el.innerHTML = `
                <div class="server-info">
                    <div class="server-name">${svc.name}</div>
                    <div class="server-price">R$ ${svc.price.toFixed(2)}</div>
                </div>
                <button class="btn" style="padding: 6px 12px; font-size: 13px;">Comprar</button>
            `;
            
            // Handle buy click
            const btn = el.querySelector('button');
            btn.onclick = async (e) => {
                e.stopPropagation();
                showConfirm(`Confirmar compra de ${svc.name} por R$ ${svc.price.toFixed(2)}?`, async () => {
                    await buyChinaSmsNumber(svc.id, svc.name, btn);
                });
            };

            list.appendChild(el);
        });
    }

    async function chinaSmsApiCall(endpoint, body) {
        const token = state.chinaSmsToken;
        if (!token) {
            showToast('Por favor, insira e salve seu Token do ChinaSMS primeiro.', 'error');
            return null;
        }
        
        // Adiciona timestamp para evitar cache do proxy/navegador e for√ßar saldo atualizado
        const timestamp = new Date().getTime();
        const url = `${CHINA_SMS_API_URL}/${endpoint}?_=${timestamp}`;
        const options = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, ...body }),
            cache: 'no-store'
        };

        try {
            let response;
            try {
                response = await fetch(url, options);
            } catch (err) {
                console.warn('Falha na conex√£o direta (CORS?), tentando proxy...', err);
                response = await fetch(`${CORS_PROXY}${encodeURIComponent(url)}`, options);
            }
            
            const data = await response.json();

            if (!response.ok) {
                let errorMsg = data.error || `Erro ${response.status}`;
                if (response.status === 401) errorMsg = 'Token inv√°lido.';
                if (response.status === 402) errorMsg = 'Saldo insuficiente.';
                if (response.status === 503) errorMsg = 'Sem n√∫meros dispon√≠veis para este servi√ßo.';
                throw new Error(errorMsg);
            }
            
            return data;
        } catch (error) {
            console.error(`Erro na API ChinaSMS (${endpoint}):`, error);
            showToast(`Erro na API ChinaSMS: ${error.message}`, 'error');
            return null;
        }
    }

    function renderSmsServices() {
        const container = document.getElementById('sms24hSelectionArea');
        const backBtn = document.getElementById('sms24hBackBtn');
        const detailArea = document.getElementById('sms24hDetailArea');
        const gridArea = document.getElementById('sms24hGridArea');
        
        if (!container) return;
        
        // Reset view to grid
        if(backBtn) backBtn.style.display = 'none';
        if(detailArea) detailArea.style.display = 'none';
        if(gridArea) {
            gridArea.style.display = 'grid';
            gridArea.innerHTML = '';
        } else {
            // Se n√£o existir, cria a estrutura
            container.innerHTML = `
                <div id="sms24hGridArea" class="service-grid"></div>
                <div id="sms24hDetailArea" style="display:none"></div>
            `;
        }
        
        const grid = document.getElementById('sms24hGridArea');
        
        // Renderiza apenas os servi√ßos da lista definida (Bancos existentes)
        SMS_SERVICES_LIST.forEach(svc => {
            const el = document.createElement('div');
            el.className = 'service-item';
            el.innerHTML = `
                <div class="service-icon">${svc.icon}</div>
                <div class="service-name">${svc.name}</div>
            `;
            el.onclick = () => selectSms24hService(svc.id, svc.name);
            grid.appendChild(el);
        });
    }
    // Expor fun√ß√£o para o bot√£o Voltar no HTML
    window.renderSmsServices = renderSmsServices;

    function selectSms24hService(serviceId, serviceName) {
        const backBtn = document.getElementById('sms24hBackBtn');
        const detailArea = document.getElementById('sms24hDetailArea');
        const gridArea = document.getElementById('sms24hGridArea');
        
        if(backBtn) backBtn.style.display = 'block';
        if(gridArea) gridArea.style.display = 'none';
        if(detailArea) {
            detailArea.style.display = 'block';
            
            // Busca pre√ßo se dispon√≠vel
            let priceDisplay = '';
            // Tenta pegar pre√ßo manual primeiro, depois cache da API
            const manualSvc = SMS_SERVICES_LIST.find(s => s.id === serviceId);
            if (manualSvc && manualSvc.manualPrice) {
                priceDisplay = `<div class="muted" style="margin-bottom:10px">Pre√ßo estimado: R$ ${manualSvc.manualPrice.toFixed(2)}</div>`;
            } else if (smsPricesCache[serviceId]) {
                priceDisplay = `<div class="muted" style="margin-bottom:10px">Pre√ßo estimado: R$ ${(smsPricesCache[serviceId].price / 100).toFixed(2)}</div>`;
            }

            detailArea.innerHTML = `
                <h3 style="margin-top:0; color:var(--accent)">${serviceName}</h3>
                ${priceDisplay}
                <div class="field" style="margin-bottom:16px">
                    <label for="smsOperator">Operadora (Brasil)</label>
                    <select id="smsOperator">
                        <option value="any">Qualquer</option>
                        <option value="vivo">Vivo</option>
                        <option value="tim">TIM</option>
                        <option value="claro">Claro</option>
                        <option value="oi">Oi</option>
                    </select>
                </div>
                <button class="btn" id="getNumberBtn" style="width: 100%; padding: 12px;">Pedir N√∫mero (${serviceName})</button>
            `;

            // Re-attach event listener for the new button
            document.getElementById('getNumberBtn').onclick = () => buySms24hNumber(serviceId, serviceName);
        }
    }

    document.getElementById('refreshSmsPrices')?.addEventListener('click', () => {
        fetchAndDisplaySmsPrices();
    });

    window.updateSmsBalance = async () => {
        const balanceEl = document.getElementById('smsBalance');
        if(balanceEl) balanceEl.textContent = '...';
        const response = await smsApiCall({ action: 'getBalance' });
        if (response && response.startsWith('ACCESS_BALANCE:')) {
            const balance = response.split(':')[1];
            if(balanceEl) balanceEl.textContent = `R$ ${parseFloat(balance).toFixed(2)}`;
        }
    };

    window.updateChinaSmsBalance = async () => {
        const balanceEl = document.getElementById('chinaSmsBalance');
        if(balanceEl && balanceEl.textContent === 'R$ --,--') balanceEl.textContent = '...';
        const response = await chinaSmsApiCall('balance', {});
        if (response) {
             // Tenta ler 'saldo' ou 'saldo_restante' para garantir compatibilidade
             const val = response.saldo !== undefined ? response.saldo : response.saldo_restante;
             if (val !== undefined && balanceEl) {
                 balanceEl.textContent = `R$ ${parseFloat(val).toFixed(2)}`;
             }
        }
    };

    function renderSmsActivations() {
        const container = document.getElementById('smsActivationsList');
        if (!container) return;

        if (!state.smsActivations || state.smsActivations.length === 0) {
            container.innerHTML = '<div class="sms-empty-msg muted" style="text-align: center; padding: 30px;">Nenhuma ativa√ß√£o em andamento.</div>';
            return;
        }
        
        // Filtra ativa√ß√µes pelo provedor atual
        const currentProvider = state.currentSmsProvider || 'sms24h';
        const filteredActivations = state.smsActivations.filter(act => 
            (act.provider === currentProvider) || (!act.provider && currentProvider === 'sms24h')
        );

        if (filteredActivations.length === 0) {
            container.innerHTML = '<div class="sms-empty-msg muted" style="text-align: center; padding: 30px;">Nenhuma ativa√ß√£o ativa neste provedor.</div>';
            return;
        }
        
        // Limpa mensagem de vazio se tiver itens
        const emptyMsg = container.querySelector('.sms-empty-msg');
        if (emptyMsg) container.innerHTML = '';

        // Remove cards de ativa√ß√µes que n√£o existem mais
        const activeIds = new Set(filteredActivations.map(a => a.id));
        Array.from(container.children).forEach(child => {
            if (child.dataset.id && !activeIds.has(child.dataset.id)) {
                child.remove();
            }
        });

        filteredActivations.forEach((act) => {
            let card = document.getElementById(`sms-card-${act.id}`);
            
            const timeElapsed = (new Date() - new Date(act.startTime)) / 1000;
            const timeRemaining = Math.max(0, 1380 - timeElapsed); // 23 min timeout (1380s)
            const progressPercent = (timeRemaining / 1380) * 100;
            
            let statusText = 'Aguardando SMS...';
            let badgeClass = 'waiting';
            if (act.status === 'received') {
                statusText = 'SMS Recebido!';
                badgeClass = 'received';
            } else if (act.status === 'error' || timeRemaining <= 0) {
                statusText = 'Falhou ou expirou';
                badgeClass = 'error';
            }

            const timerText = `${Math.floor(timeRemaining/60)}:${String(Math.floor(timeRemaining%60)).padStart(2,'0')}`;
            const codeText = act.code || '------';

            // L√≥gica para mensagens longas (ex: servi√ßo "Outros")
            const isLongText = codeText.length > 12;
            const displayStyle = isLongText 
                ? 'font-size: 15px; font-weight: 600; letter-spacing: normal; word-break: break-word; line-height: 1.4;' 
                : 'font-size: 24px; font-weight: 700; letter-spacing: 4px; font-family: monospace;';
            
            let extractedCode = null;
            if (isLongText) {
                const match = codeText.match(/\b\d{4,8}\b/);
                if (match) extractedCode = match[0];
            }

            if (!card) {
                // Cria o card se n√£o existir
                card = document.createElement('div');
                card.className = 'card';
                card.id = `sms-card-${act.id}`;
                card.dataset.id = act.id;
                card.style.marginBottom = '10px';

                // Remove DDI 55 se for Brasil para facilitar a c√≥pia
                let numberNoDDI = act.number;
                if (numberNoDDI.startsWith('55')) numberNoDDI = numberNoDDI.substring(2);

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                                <h4 style="margin:0;font-size:20px;">Numero: <span style="font-family:monospace;color:var(--accent);">${act.number}</span></h4>
                                <button class="btn ghost" style="padding:2px 6px;font-size:12px" onclick="copyToClipboard('${numberNoDDI}', this)" title="Copiar sem DDI (55)">Copiar</button>
                            </div>
                            <div class="muted" style="font-size: 12px;">Servi√ßo: ${act.serviceName} | ID: ${act.id}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="status-badge ${badgeClass}">${statusText}</div>
                            <div class="timer-text" class="muted" style="font-size: 12px;">Tempo: ${timerText}</div>
                            ${act.status === 'waiting' ? `<div style="margin-top:4px"><button class="btn ghost" style="padding:2px 6px;font-size:10px" onclick="forceCheckSms('${act.id}')" title="For√ßar verifica√ß√£o na API agora">‚ö° Checar</button></div>` : ''}
                        </div>
                    </div>
                    <div class="sms-code-container" style="margin-top: 16px; background: rgba(0,0,0,0.1); padding: 12px; border-radius: 8px; text-align: center; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height: 80px;">
                        <div class="muted" style="font-size: 12px; margin-bottom: 4px;">${isLongText ? 'Mensagem Recebida' : 'C√≥digo Recebido'}</div>
                        <div class="sms-code-display" style="${displayStyle}">
                            ${codeText}
                        </div>
                        ${act.code ? `
                            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; justify-content:center;">
                                <button class="btn ghost" style="padding: 2px 8px; font-size: 12px;" onclick="copyToClipboard('${act.code}', this)">${isLongText ? 'Copiar Msg' : 'Copiar C√≥digo'}</button>
                                ${extractedCode ? `<button class="btn ghost" style="padding: 2px 8px; font-size: 12px; color:var(--accent); border-color:var(--accent);" onclick="copyToClipboard('${extractedCode}', this)">Copiar C√≥digo (${extractedCode})</button>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="sms-actions" style="margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end;">
                        ${act.status === 'received' ? `
                            <button class="btn success" onclick="finishSmsActivation('${act.id}')" title="Confirmar e concluir (Status 6)" style="flex:1">‚úÖ Finalizar</button>
                            <button class="btn ghost" onclick="retrySmsActivation('${act.id}')" title="Pedir outro SMS no mesmo n√∫mero (Status 3)" style="flex:1">üîÑ Outro SMS</button>
                        ` : ''}
                        <button class="btn danger btn-cancel" onclick="cancelSmsActivation('${act.id}')" style="flex:1">‚úñ Cancelar</button>
                    </div>
                `;
                container.appendChild(card);
            } else {
                // Atualiza apenas os elementos que mudam (evita piscar)
                const statusEl = card.querySelector('.status-badge');
                if (statusEl.textContent !== statusText) {
                    statusEl.textContent = statusText;
                    statusEl.className = `status-badge ${badgeClass}`;
                }
                
                const timerEl = card.querySelector('.timer-text');
                const newTimerText = `Tempo: ${timerText}`;
                if (timerEl && timerEl.textContent !== newTimerText) timerEl.textContent = newTimerText;

                const progressEl = card.querySelector('.sms-progress-fill');
                if (progressEl) {
                    progressEl.style.width = `${progressPercent}%`;
                    progressEl.style.background = badgeClass === 'error' ? 'var(--danger)' : (badgeClass === 'received' ? 'var(--success)' : 'var(--accent)');
                }

                const codeEl = card.querySelector('.sms-code-display');
                if (codeEl && codeEl.textContent.trim() !== codeText) {
                    // Atualiza todo o container para lidar com mudan√ßa de estilo e bot√µes extras
                    const container = card.querySelector('.sms-code-container');
                    container.innerHTML = `
                        <div class="muted" style="font-size: 12px; margin-bottom: 4px;">${isLongText ? 'Mensagem Recebida' : 'C√≥digo Recebido'}</div>
                        <div class="sms-code-display" style="${displayStyle}">
                            ${codeText}
                        </div>
                        ${act.code ? `
                            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; justify-content:center;">
                                <button class="btn ghost" style="padding: 2px 8px; font-size: 12px;" onclick="copyToClipboard('${act.code}', this)">${isLongText ? 'Copiar Msg' : 'Copiar C√≥digo'}</button>
                                ${extractedCode ? `<button class="btn ghost" style="padding: 2px 8px; font-size: 12px; color:var(--accent); border-color:var(--accent);" onclick="copyToClipboard('${extractedCode}', this)">Copiar C√≥digo (${extractedCode})</button>` : ''}
                            </div>
                        ` : ''}
                    `;
                }

                const actionsEl = card.querySelector('.sms-actions');
                if (actionsEl) {
                    const hasFinishBtn = actionsEl.querySelector('button[onclick^="finishSmsActivation"]');
                    if (act.status === 'received' && !hasFinishBtn) {
                        actionsEl.innerHTML = `
                            <button class="btn success" onclick="finishSmsActivation('${act.id}')" title="Confirmar e concluir (Status 6)" style="flex:1">‚úÖ Finalizar</button>
                            <button class="btn ghost" onclick="retrySmsActivation('${act.id}')" title="Pedir outro SMS no mesmo n√∫mero (Status 3)" style="flex:1">üîÑ Outro SMS</button>
                            <button class="btn danger btn-cancel" onclick="cancelSmsActivation('${act.id}')" style="flex:1">‚úñ Cancelar</button>
                        `;
                    }
                }
            }

            // L√≥gica do Temporizador de Cancelamento (China SMS)
            const cancelBtn = card.querySelector('.btn-cancel');
            if (cancelBtn && act.provider === 'chinasms' && act.status === 'waiting') {
                // Aplica a restri√ß√£o de 2 minutos para todos os servi√ßos do ChinaSMS, conforme solicitado.
                if (timeElapsed < 120) {
                    const remaining = 120 - Math.floor(timeElapsed);
                    const newText = `Cancelar (${remaining}s)`;
                    // Atualiza apenas o texto do n√≥ de texto, evitando recriar o bot√£o
                    if (cancelBtn.innerText !== newText) cancelBtn.innerText = newText;
                    if (!cancelBtn.disabled) {
                        cancelBtn.disabled = true;
                        cancelBtn.style.opacity = '0.6';
                        cancelBtn.style.cursor = 'not-allowed';
                    }
                } else {
                    if (cancelBtn.disabled) {
                        cancelBtn.disabled = false;
                        cancelBtn.style.opacity = '1';
                        cancelBtn.style.cursor = 'pointer';
                        cancelBtn.innerText = '‚úñ Cancelar';
                    }
                }
            }
        });
    }

    window.copyToClipboard = (text, btn) => {
        navigator.clipboard.writeText(text).then(() => {
            const original = btn.textContent;
            btn.textContent = 'Copiado!';
            setTimeout(() => btn.textContent = original, 1500);
        });
    };

    window.forceCheckSms = async (id) => {
        const act = state.smsActivations.find(a => a.id === id);
        if(!act) return;
        
        showToast('Verificando status na API...', 'info');
        
        if(act.provider === 'chinasms') {
            // Para ChinaSMS, abortamos o polling atual e iniciamos um novo imediatamente
            if(chinaSmsPollingControllers[id]) {
                chinaSmsPollingControllers[id].abort();
                delete chinaSmsPollingControllers[id];
            }
            startChinaSmsPolling(act);
        } else {
            // Para SMS24h, fazemos uma chamada direta
            const response = await smsApiCall({ action: 'getStatus', id: act.id });
            if (response && response.startsWith('STATUS_OK:')) {
                // O polling normal vai pegar isso, mas podemos acelerar se quisermos
            }
        }
    };

    document.getElementById('saveSmsApiKey')?.addEventListener('click', () => {
        const key = document.getElementById('smsApiKey').value.trim();
        if (key) {
            state.smsApiKey = key;
            saveDataImmediate();
            showToast('Chave API salva com sucesso!', 'success');
            document.getElementById('checkSmsBalance').click();
        }
    });

    document.getElementById('checkSmsBalance')?.addEventListener('click', async () => {
        window.updateSmsBalance();
    });

    async function buySms24hNumber(serviceId, serviceName) {
        const btn = document.getElementById('getNumberBtn');
        if(!btn) return;
        btn.textContent = 'Aguarde...';
        btn.disabled = true;

        const operator = document.getElementById('smsOperator').value;

        const response = await smsApiCall({ action: 'getNumber', service: serviceId, operator: operator, country: 73 });

        if (response && response.startsWith('ACCESS_NUMBER:')) {
            const [, id, number] = response.split(':');
            const newActivation = { id, number, service: serviceId, serviceName, operator, startTime: new Date().toISOString(), status: 'waiting', code: null, provider: 'sms24h' };
            state.smsActivations.push(newActivation);
            saveDataImmediate();
            renderSmsActivations();
            startSmsPolling(newActivation);
            window.updateSmsBalance(); // Atualiza saldo
            
            // Volta para a grade ou avisa?
            // alert('N√∫mero gerado!');
        } else {
            if(response) showToast(`Erro ao pedir n√∫mero: ${response}`, 'error');
        }

        btn.textContent = `Pedir N√∫mero (${serviceName})`;
        btn.disabled = false;
    }

    function startSmsPolling(activation) {
        if (smsPollingIntervals[activation.id]) clearInterval(smsPollingIntervals[activation.id]);

        const intervalId = setInterval(async () => {
            const actIndex = state.smsActivations.findIndex(a => a.id === activation.id);
            if (actIndex === -1) { clearInterval(intervalId); delete smsPollingIntervals[activation.id]; return; }
            
            const timeElapsed = (new Date() - new Date(state.smsActivations[actIndex].startTime)) / 1000;
            if (timeElapsed > 1380) { // 23 minutos
                clearInterval(intervalId); delete smsPollingIntervals[activation.id];
                // Cancela automaticamente para devolver o saldo
                cancelSmsActivation(activation.id);
            } else {
                const response = await smsApiCall({ action: 'getStatus', id: activation.id });
                if (response && response.startsWith('STATUS_OK:')) {
                    const code = response.split(':')[1];
                    state.smsActivations[actIndex].code = code;
                    state.smsActivations[actIndex].status = 'received';
                    
                    // Contabilidade Autom√°tica
                    if (!state.smsActivations[actIndex].costAdded) {
                        const price = getServicePrice('sms24h', state.smsActivations[actIndex].service);
                        state.gastoNumeros = (state.gastoNumeros || 0) + price;
                        state.smsActivations[actIndex].costAdded = true;
                        showToast(`Custo de R$ ${price.toFixed(2)} adicionado aos gastos com N√∫meros.`, 'info');
                        updateUI(); // Atualiza a aba de gastos e totais automaticamente
                    }

                    clearInterval(intervalId); delete smsPollingIntervals[activation.id];
                    // Tocar som de notifica√ß√£o
                    showToast(`SMS Recebido: ${code}`, 'success');
                    if(state.autoCopySms) {
                        navigator.clipboard.writeText(code).catch(e => console.error(e));
                        showToast('C√≥digo copiado automaticamente!', 'info');
                    }
                    playNotificationSound();
                    sendBrowserNotification(`C√≥digo: ${code}`, `SMS Recebido de ${activation.serviceName}`);
                }
            }
            saveDataImmediate();
            renderSmsActivations();
        }, 10000); // Aumentado para 10s para reduzir carga no servidor
        smsPollingIntervals[activation.id] = intervalId;
    }
    
    function restartSmsPolls() {
        if (!state.smsActivations) return;
        state.smsActivations.forEach(act => {
            if (act.status === 'waiting') {
                const timeElapsed = (new Date() - new Date(act.startTime)) / 1000;
                if (timeElapsed > 1380) {
                    // Se j√° passou de 23 min ao carregar, cancela
                    cancelSmsActivation(act.id);
                } else {
                    if (act.provider === 'chinasms') {
                        startChinaSmsPolling(act);
                    } else {
                        startSmsPolling(act);
                    }
                }
            }
        });
    }

    window.checkExpiredActivations = async () => {
        if (!state.smsActivations) return;
        
        // Atualiza saldos
        window.updateSmsBalance();
        window.updateChinaSmsBalance();

        let count = 0;
        const activations = [...state.smsActivations]; // C√≥pia para iterar
        for (const act of activations) {
            const timeElapsed = (new Date() - new Date(act.startTime)) / 1000;
            if (act.status === 'waiting' && timeElapsed > 1380) {
                await cancelSmsActivation(act.id);
                count++;
            } else if (act.status === 'waiting' && act.provider === 'chinasms') {
                // For√ßa rein√≠cio do polling se estiver parado, para garantir sincronia
                if (!chinaSmsPollingControllers[act.id]) {
                    startChinaSmsPolling(act);
                }
            }
        }
        
        if(count > 0) showToast(`${count} ativa√ß√µes expiradas foram canceladas.`, 'info');
        else {
            // Feedback visual sutil
            const btns = document.querySelectorAll('button[onclick="checkExpiredActivations()"]');
            btns.forEach(btn => {
                const original = btn.textContent;
                btn.textContent = 'Sincronizado!';
                setTimeout(() => btn.textContent = original, 2000);
            });
        }
    };

    window.getExtraSms = async (id) => {
        const index = state.smsActivations.findIndex(a => a.id == id);
        if (index === -1) return;
        const activation = state.smsActivations[index];
        const response = await smsApiCall({ action: 'getExtraActivation', activationId: activation.id });
        if (response && response.startsWith('ACCESS_NUMBER:')) {
            const [, newId] = response.split(':');
            state.smsActivations[index] = { ...activation, id: newId, startTime: new Date().toISOString(), status: 'waiting', code: null };
            saveDataImmediate();
            renderSmsActivations();
            startSmsPolling(state.smsActivations[index]);
            showToast('Nova ativa√ß√£o solicitada. Aguardando novo SMS.', 'info');
        } else {
            if(response) showToast(`Erro ao pedir SMS extra: ${response}`, 'error');
        }
    };

    window.finishSmsActivation = async (id) => {
        const index = state.smsActivations.findIndex(a => a.id == id);
        if (index === -1) return;
        const activation = state.smsActivations[index];
        
        // Salva no hist√≥rico antes de finalizar
        if (!state.smsHistory) state.smsHistory = [];
        state.smsHistory.unshift({ ...activation, finishedAt: new Date().toISOString() });
        if (state.smsHistory.length > 50) state.smsHistory.length = 50;
        renderSmsHistory();
        
        if (activation.provider !== 'chinasms') {
            await smsApiCall({ action: 'setStatus', status: 6, id: activation.id });
        }
        state.smsActivations.splice(index, 1);
        saveDataImmediate();
        renderSmsActivations();
        updateUI(); // Garante que a interface reflita qualquer mudan√ßa final
        window.updateSmsBalance(); // Atualiza saldo
    };

    window.retrySmsActivation = async (id) => {
        const index = state.smsActivations.findIndex(a => a.id == id);
        if (index === -1) return;
        const activation = state.smsActivations[index];
        
        // Salva o c√≥digo atual no hist√≥rico antes de pedir outro
        if (activation.code) {
            if (!state.smsHistory) state.smsHistory = [];
            state.smsHistory.unshift({ ...activation, finishedAt: new Date().toISOString() });
            renderSmsHistory();
        }

        if (activation.provider === 'chinasms') {
            const response = await chinaSmsApiCall('retry', { aid: activation.id });
            if (response && response.status === 'success') {
                state.smsActivations[index].code = null;
                state.smsActivations[index].status = 'waiting';
                state.smsActivations[index].startTime = new Date().toISOString();
                saveDataImmediate();
                renderSmsActivations();
                startChinaSmsPolling(state.smsActivations[index]);
            }
        } else { // sms24h
            const response = await smsApiCall({ action: 'setStatus', status: 3, id: activation.id });
            
            if (response && (response.includes('ACCESS_RETRY_GET') || response.includes('ACCESS_READY'))) {
                 state.smsActivations[index].code = null;
                 state.smsActivations[index].status = 'waiting';
                 saveDataImmediate();
                 renderSmsActivations();
                 startSmsPolling(state.smsActivations[index]);
            } else {
                 showToast('Erro ao solicitar outro SMS: ' + response, 'error');
            }
        }
    };

    window.cancelSmsActivation = async (id) => {
        const index = state.smsActivations.findIndex(a => a.id == id);
        if (index === -1) return;
        const activation = state.smsActivations[index];

        if (activation.provider === 'chinasms') {
            const result = await chinaSmsApiCall('cancel', { aid: activation.id });
            
            // Corre√ß√£o Ghost SMS: Se falhar (null), n√£o remove o card e tenta buscar o c√≥digo
            if (!result) {
                showToast('Cancelamento falhou. Verificando se o SMS chegou...', 'info');
                if (!chinaSmsPollingControllers[activation.id]) {
                    startChinaSmsPolling(activation);
                }
                return; 
            }

            if (chinaSmsPollingControllers[activation.id]) {
                chinaSmsPollingControllers[activation.id].abort();
                delete chinaSmsPollingControllers[activation.id];
            }
            window.updateChinaSmsBalance();
        } else { // sms24h
            await smsApiCall({ action: 'setStatus', status: 8, id: activation.id });
            if (smsPollingIntervals[activation.id]) {
                clearInterval(smsPollingIntervals[activation.id]);
                delete smsPollingIntervals[activation.id];
            }
            window.updateSmsBalance();
        }

        state.smsActivations.splice(index, 1);
        saveDataImmediate();
        renderSmsActivations();
    };

    window.switchSmsTab = (tab) => {
        const activeContainer = document.getElementById('smsActiveContainer');
        const historyContainer = document.getElementById('smsHistoryContainer');
        const tabActive = document.getElementById('tabSmsActive');
        const tabHistory = document.getElementById('tabSmsHistory');

        activeContainer.style.display = tab === 'active' ? 'block' : 'none';
        historyContainer.style.display = tab === 'history' ? 'block' : 'none';
        
        if(tab === 'active') { tabActive.classList.add('active'); tabHistory.classList.remove('active'); }
        else { tabHistory.classList.add('active'); tabActive.classList.remove('active'); }
    };

    function renderSmsHistory() {
        const container = document.getElementById('smsHistoryList');
        if (!container) return;

        // Filtra hist√≥rico pelo provedor atual
        const currentProvider = state.currentSmsProvider || 'sms24h';
        const filteredHistory = state.smsHistory.filter(h => 
            (h.provider === currentProvider) || (!h.provider && currentProvider === 'sms24h')
        );

        if (filteredHistory.length === 0) {
            container.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">Nenhum hist√≥rico dispon√≠vel.</div>';
            return;
        }

        container.innerHTML = '';
        filteredHistory.forEach(item => {
            const date = new Date(item.finishedAt).toLocaleString('pt-BR');
            const el = document.createElement('div');
            el.style.padding = '12px';
            el.style.borderBottom = '1px solid rgba(0,0,0,0.05)';
            el.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:4px; font-size:13px;">
                    <strong>${item.serviceName}</strong>
                    <span class="muted">${date}</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-family:monospace; color:var(--text);">${item.number}</div>
                    <div style="font-weight:700; font-family:monospace; color:var(--success); font-size:16px; letter-spacing:1px;">${item.code || '---'}</div>
                </div>
            `;
            container.appendChild(el);
        });
    }

    window.clearSmsHistory = () => {
        showConfirm('Limpar todo o hist√≥rico de SMS?', () => {
            state.smsHistory = [];
            saveDataImmediate();
            renderSmsHistory();
        }, { isDanger: true, title: 'Limpar Hist√≥rico SMS' });
    };

    window.selectSmsProvider = (provider) => {
        state.currentSmsProvider = provider;
        saveDataImmediate();

        document.querySelectorAll('.provider-card').forEach(el => el.classList.remove('selected'));
        document.getElementById('card-' + provider).classList.add('selected');

        document.getElementById('sms24hContainer').style.display = provider === 'sms24h' ? 'block' : 'none';
        document.getElementById('chinaSmsContainer').style.display = provider === 'chinasms' ? 'block' : 'none';
        
        // Atualiza o saldo automaticamente ao trocar de provedor
        if (provider === 'chinasms') {
            window.updateChinaSmsBalance();
        } else if (provider === 'sms24h') {
            window.updateSmsBalance();
        }

        renderSmsActivations();
        renderSmsHistory();
    };

    window.switchSmsSubTab = (provider, tab) => {
        const activationView = document.getElementById(provider + 'ActivationView');
        const configView = document.getElementById(provider + 'ConfigView');
        const btnActivation = document.getElementById(provider === 'sms24h' ? 'btnSms24hActivation' : 'btnChinaSmsActivation');
        const btnConfig = document.getElementById(provider === 'sms24h' ? 'btnSms24hConfig' : 'btnChinaSmsConfig');

        activationView.style.display = tab === 'activation' ? 'block' : 'none';
        configView.style.display = tab === 'config' ? 'block' : 'none';

        // Update button styles
        btnActivation.style.borderColor = tab === 'activation' ? 'var(--accent)' : 'transparent';
        btnActivation.style.color = tab === 'activation' ? 'var(--text)' : 'var(--muted)';
        btnConfig.style.borderColor = tab === 'config' ? 'var(--accent)' : 'transparent';
        btnConfig.style.color = tab === 'config' ? 'var(--text)' : 'var(--muted)';
    };

    async function fetchAndDisplaySmsPrices() {
        const serviceSelect = document.getElementById('smsService');
        const refreshBtn = document.getElementById('refreshSmsPrices');
        
        if(refreshBtn) {
            refreshBtn.classList.add('active');
            refreshBtn.textContent = '‚è≥';
        }

        const response = await smsApiCall({ action: 'getPrices', country: 73 });
        
        if(refreshBtn) {
            refreshBtn.classList.remove('active');
            refreshBtn.textContent = 'üîÑ';
        }

        if (response) {
            try {
                const prices = JSON.parse(response);
                const services = prices['73']; // Prices for Brazil
                if (!services) return;
                
                Object.keys(services).forEach(svcId => {
                    const priceMap = services[svcId];
                    const priceKeys = Object.keys(priceMap);
                    if (priceKeys.length > 0) {
                        const priceStr = priceKeys[0];
                        const count = priceMap[priceStr];
                        smsPricesCache[svcId] = { price: parseFloat(priceStr), count: count };
                    }
                });
                renderSmsServices(); // Re-renderiza com pre√ßos
                serviceSelect.dataset.pricesLoaded = 'true';
            } catch (e) {
                console.error('Erro ao processar pre√ßos do SMS:', e);
            }
        }
    }

    window.testNotificationSound = () => {
        const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        audio.play().catch(e => showToast('O navegador bloqueou o som. Interaja com a p√°gina.', 'error'));
    };

    // --- China SMS Specific Logic ---
    let chinaSmsPollingControllers = {}; // To allow aborting fetch requests

    async function startChinaSmsPolling(activation) {
        if (chinaSmsPollingControllers[activation.id]) {
            chinaSmsPollingControllers[activation.id].abort();
        }
        const controller = new AbortController();
        chinaSmsPollingControllers[activation.id] = controller;

        const token = state.chinaSmsToken;
        if (!token) return;

        // Verifica timeout de 23 min (1380s)
        const timeElapsed = (new Date() - new Date(activation.startTime)) / 1000;
        if (timeElapsed > 1380) {
            cancelSmsActivation(activation.id);
            return;
        }

        try {
            const timestamp = new Date().getTime();
            const url = `${CHINA_SMS_API_URL}/wait?_=${timestamp}`;
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, aid: activation.id, timeout: 90 }),
                signal: controller.signal
            };

            let response;
            try {
                response = await fetch(url, options);
            } catch (err) {
                if (err.name === 'AbortError') throw err;
                response = await fetch(`${CORS_PROXY}${encodeURIComponent(url)}`, options);
            }

            if (!response.ok) {
                if (controller.signal.aborted) return;
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const actIndex = state.smsActivations.findIndex(a => a.id === activation.id);
            if (actIndex === -1) return;

            if (data.status === 'received' && data.sms && data.sms.length > 0) {
                state.smsActivations[actIndex].code = data.sms[0];
                state.smsActivations[actIndex].status = 'received';
                delete chinaSmsPollingControllers[activation.id];
                
                // Contabilidade Autom√°tica
                if (!state.smsActivations[actIndex].costAdded) {
                    const price = getServicePrice('chinasms', state.smsActivations[actIndex].service);
                    state.gastoChinaSms = (state.gastoChinaSms || 0) + price;
                    state.smsActivations[actIndex].costAdded = true;
                    showToast(`Custo de R$ ${price.toFixed(2)} adicionado aos gastos China SMS.`, 'info');
                    updateUI(); // Atualiza a aba de gastos e totais automaticamente
                }

                showToast(`SMS Recebido (China): ${data.sms[0]}`, 'success');
                if(state.autoCopySms) {
                    navigator.clipboard.writeText(data.sms[0]).catch(e => console.error(e));
                    showToast('C√≥digo copiado automaticamente!', 'info');
                }
                playNotificationSound();
                sendBrowserNotification(`C√≥digo: ${data.sms[0]}`, `China SMS: ${activation.serviceName}`);
            } else if (data.status === 'waiting' && data.timeout) {
                setTimeout(() => startChinaSmsPolling(activation), 3000); // Delay de 3s para evitar flood
            } else if (data.status === 'canceled') {
                state.smsActivations.splice(actIndex, 1);
                delete chinaSmsPollingControllers[activation.id];
            }
            
            saveDataImmediate();
            renderSmsActivations();

        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('Error in ChinaSMS long-polling:', error);
            }
        }
    }

    async function buyChinaSmsNumber(serviceId, serviceName, btnElement) {
        const originalText = btnElement.textContent;
        btnElement.textContent = '...'; btnElement.disabled = true;

        const response = await chinaSmsApiCall('buy', { service: serviceId });

        if (response && response.status === 'success') {
            const newActivation = { id: response.aid, number: response.number, service: serviceId, serviceName, startTime: new Date().toISOString(), status: 'waiting', code: null, provider: 'chinasms' };
            state.smsActivations.push(newActivation);
            saveDataImmediate();
            renderSmsActivations();
            startChinaSmsPolling(newActivation);
            
            if (response.saldo_restante !== undefined) {
                const balanceEl = document.getElementById('chinaSmsBalance');
                if(balanceEl) balanceEl.textContent = `R$ ${parseFloat(response.saldo_restante).toFixed(2)}`;
            } else {
                window.updateChinaSmsBalance();
            }
            
            // Go back to main grid or stay? Maybe stay to buy more.
            // But let's alert or scroll to active
            // alert('N√∫mero adquirido com sucesso!');
        }
        btnElement.textContent = originalText; btnElement.disabled = false;
    }

    window.toggleAutoCopy = (checked) => {
        state.autoCopySms = checked;
        saveDataImmediate();
    };

    window.toggleSound = (checked) => {
        state.soundEnabled = checked;
        saveDataImmediate();
    };

    window.playNotificationSound = () => {
        if(!state.soundEnabled) return;
        new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(e => console.warn('Som bloqueado:', e));
    };

    window.requestNotificationPermission = () => {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                showToast('Notifica√ß√µes ativadas!', 'success');
                document.getElementById('btnEnableNotif').style.display = 'none';
                new Notification("Painel Financeiro", { body: "As notifica√ß√µes est√£o funcionando!" });
            }
        });
    };

    window.sendBrowserNotification = (title, body) => {
        if (Notification.permission === "granted") {
            new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/561/561188.png' });
        }
    };

    window.showToast = (message, type = 'info') => {
        const container = document.getElementById('toastContainer');
        if(!container) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <div style="font-size:18px">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</div>
            <div>${message}</div>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    };

    // --- init
    loadData();
    // ensure gasto inputs exist and set their values
    const gp = document.getElementById('gastoProxy');
    const gn = document.getElementById('gastoNumeros');
    const gb = document.getElementById('gastoBot');
    const gcs = document.getElementById('gastoChinaSms');
    if(gp) gp.value = String(state.gastoProxy || 0).replace('.',',');
    if(gn) gn.value = String(state.gastoNumeros || 0).replace('.',',');
    if(gb) gb.value = String(state.gastoBot || 0).replace('.',',');
    if(gcs) gcs.value = String(state.gastoChinaSms || 0).replace('.',',');

    // ensure selected platform exists
    if(!state.selectedPlatform) state.selectedPlatform = Object.keys(state.platforms)[0] || null;

    populateDaySelect();
    restartSmsPolls();

    document.getElementById('saveChinaSmsToken')?.addEventListener('click', () => {
        const token = document.getElementById('chinaSmsToken').value.trim();
        if (token) {
            state.chinaSmsToken = token;
            saveDataImmediate();
            showToast('Token do ChinaSMS salvo com sucesso!', 'success');
            document.getElementById('checkChinaSmsBalance').click();
        }
    });

    document.getElementById('checkChinaSmsBalance')?.addEventListener('click', async () => {
        window.updateChinaSmsBalance();
    });

    document.getElementById('logoUpload').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const dataUrl = e.target.result;
            document.getElementById('brandLogo').src = dataUrl;
            state.brandLogo = dataUrl;
            saveDataImmediate();
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('editAppTitleBtn').addEventListener('click', () => {
        const current = state.appTitle || 'Painel Financeiro';
        showPrompt('Novo nome do Painel:', (newTitle) => {
            if(newTitle && newTitle.trim() !== '') {
                state.appTitle = newTitle.trim();
                document.getElementById('appTitleDisplay').textContent = state.appTitle;
                saveDataImmediate();
            }
        }, current);
    });

    const platformsListEl = document.getElementById('platformsList');
    if (platformsListEl) {
        new Sortable(platformsListEl, {
            animation: 150,
            onEnd: function (evt) {
                const newOrder = Array.from(evt.to.children).map(el => el.dataset.platformName);
                state.platformOrder = newOrder;
                saveDataImmediate();
            }
        });
    }


    window.addEventListener('beforeunload', (e) => {
      if(saveTimer) {
        clearTimeout(saveTimer);
        saveData();
      }
    });

    // autosave indicator change back to muted after some seconds
    setInterval(()=>{ const s = document.getElementById('saveStatus'); if(s) s.textContent = 'Sincronizado com a nuvem'; }, 5000);

    // keyboard shortcuts: Ctrl+S to save, Ctrl+E to export
    document.addEventListener('keydown', (e) => {
      if(e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveDataImmediate();
        const status = document.getElementById('saveStatus');
        if(status) {
          status.textContent = '‚úì Sincronizado (Ctrl+S)';
          setTimeout(() => { if(status) status.textContent = 'Sincronizado com a nuvem'; }, 3000);
        }
      }
      if(e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        window.exportData();
      }
    });

    // export/import shortcuts (dev)

window.exportData = ()=>{ const a = document.createElement('a'); a.href = 'data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(state)); a.download='painel_export.json'; a.click(); };
    window.importData = (raw)=>{ try{ state = JSON.parse(raw); scheduleSave(); updateUI(); showToast('Importado com sucesso', 'success'); }catch(e){ showToast('Erro ao importar', 'error'); }};
  

// Improved theme toggle: explicitly sets CSS variables for dark and light to ensure full switch
(function(){
  const root = document.documentElement;
  const setVars = (vars) => {
    Object.keys(vars).forEach(k => root.style.setProperty(k, vars[k]));
  };

  const darkVars = {
    '--bg': '#0f1115',
    '--card': '#1a1d22',
    '--muted': '#9ca3af',
    '--accent': '#3b82f6',
    '--success': '#17b169',
    '--danger': '#ff4d4f'
  };

  const lightVars = {
    '--bg': '#e8ecf1',
    '--card': '#f0f3f7',
    '--muted': '#6b7684',
    '--accent': '#2b7be4',
    '--success': '#17b169',
    '--danger': '#ff4d4f'
  };

  const applyTheme = (theme) => {
    if(theme === 'dark') {
      document.body.classList.add('dark');
      document.body.classList.remove('light');
      setVars(darkVars);
    } else {
      document.body.classList.remove('dark');
      document.body.classList.add('light');
      setVars(lightVars);
    }
  };

  // init from storage or system preference
  const saved = localStorage.getItem('temaPainel');
  if(saved === 'dark' || saved === 'light') {
    applyTheme(saved);
  } else {
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(prefersDark ? 'dark' : 'light');
  }

  // wire toggle button (if exists) to flip theme
  const btn = document.getElementById('toggleTheme');
  if(btn) {
    btn.addEventListener('click', ()=>{
      const current = document.body.classList.contains('dark') ? 'dark' : 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);
      localStorage.setItem('temaPainel', next);
      if(typeof renderDailyProfitChart === 'function' && document.getElementById('chartContainer').style.display !== 'none') {
        renderDailyProfitChart();
      }
    });
  }
})();

    }); // Fim do window.addEventListener('load')
</script>
</body>
</html>
